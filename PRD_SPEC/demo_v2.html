<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>上海中考AI择校</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --r:16px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --tap: rgba(37,99,235,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei","Noto Sans CJK SC", Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    button,input,select,textarea{font:inherit}
    .app{min-height:100%;display:flex;flex-direction:column}
    .appbar{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.95);
      backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);
      padding: calc(12px + var(--safeT)) 16px 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:16px;letter-spacing:.2px}
    .title p{margin:0;font-size:12px;color:var(--muted)}
    .iconbtn{
      width:40px;height:40px;border-radius:14px;border:1px solid var(--line);
      background:#fff;display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;transition:all 0.2s ease;
    }
    .iconbtn:hover{border-color: rgba(0,0,0,.1);box-shadow: 0 2px 4px rgba(0,0,0,.06);}
    .iconbtn:active{transform:scale(.98);background:var(--tap)}
    .icon{width:18px;height:18px;display:block}
    .content{
      flex:1 1 auto;
      padding: 16px 16px 96px;
      max-width: 560px;
      width:100%;
      margin:0 auto;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-bottom:16px;
      transition: all 0.2s ease;
    }
    .card:hover{box-shadow: 0 12px 24px rgba(17,24,39,.1);}
    .hd{
      padding:12px 16px 10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(37,99,235,.08), rgba(37,99,235,0));
    }
    .hd h2{margin:0;font-size:16px;font-weight:600}
    .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.4}
    .bd{padding:16px}
    .hint{font-size:12px;color:var(--muted);line-height:1.55}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .grid1{display:grid;grid-template-columns:1fr;gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px;font-weight:500}
    input,select,textarea{
      width:100%;
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      outline:none;
      font-size:14px;
      transition: all 0.2s ease;
    }
    input:hover,select:hover,textarea:hover{
      border-color: rgba(0,0,0,.1);
      box-shadow: 0 2px 4px rgba(0,0,0,.06);
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      padding:8px 14px;border:1px solid var(--line);border-radius:999px;
      font-size:13px;color:var(--muted);background:#fff;user-select:none;cursor:pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .pill:hover{border-color: rgba(0,0,0,.1);box-shadow: 0 2px 4px rgba(0,0,0,.06);}
    .pill.on{border-color: rgba(37,99,235,.4);background: rgba(37,99,235,.12);color: var(--brand2);}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:13px;padding:6px 12px;border-radius:999px;
      border:1px solid var(--line);background:#fff;color:var(--muted);
      white-space:nowrap;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .badge:hover{transform: translateY(-1px);}
    .badge.good{border-color: rgba(22,163,74,.3); background: rgba(22,163,74,.12); color: var(--good)}
    .badge.warn{border-color: rgba(245,158,11,.3); background: rgba(245,158,11,.15); color: var(--warn)}
    .badge.bad{border-color: rgba(239,68,68,.3); background: rgba(239,68,68,.15); color: var(--bad)}
    .mono{font-family: var(--mono)}
    .btn{
      border:1px solid var(--line);background:#fff;padding:10px 16px;border-radius:14px;
      cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center;
      user-select:none;transition:all 0.2s ease;gap:8px;
      font-weight: 500;
    }
    .btn:hover{border-color: rgba(0,0,0,.1);box-shadow: 0 2px 4px rgba(0,0,0,.06);}
    .btn:active{transform:scale(.98);background:var(--tap)}
    .btn.primary{border-color: rgba(37,99,235,.4);background: rgba(37,99,235,.12);color: var(--brand2);}
    .btn.primary:hover{background: rgba(37,99,235,.18);border-color: rgba(37,99,235,.5);}
    .btn.danger{border-color: rgba(239,68,68,.3);background: rgba(239,68,68,.12);color: var(--bad);}
    .btn.danger:hover{background: rgba(239,68,68,.18);border-color: rgba(239,68,68,.4);}
    .btnrow{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:16px}
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;
      padding: 10px 16px calc(10px + var(--safeB));
      background: rgba(255,255,255,.95);
      backdrop-filter: saturate(180%) blur(16px);
      border-top:1px solid var(--line);
      z-index:30;
      box-shadow: 0 -1px 8px rgba(0,0,0,.06);
    }
    .tabs{
      max-width:560px;margin:0 auto;
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
    }
    .tab{
      border-radius:16px;padding:12px 8px;text-align:center;color:var(--muted);
      font-size:12px;user-select:none;cursor:pointer;border:1px solid transparent;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .tab:hover{background: rgba(0,0,0,.03);}
    .tab:active{transform: scale(0.98);}
    .tab.on{color:var(--brand2);background: rgba(37,99,235,.12);border-color: rgba(37,99,235,.25);font-weight: 600;}
    .school{
      border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff;
      display:flex;flex-direction:column;gap:12px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .school:hover{box-shadow: 0 4px 12px rgba(0,0,0,.08);}
    .school .row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;}
    .school h3{margin:0;font-size:15px;font-weight:600}
    .meta{font-size:13px;color:var(--muted);line-height:1.4;margin-top:6px}
    .bar{height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;border:1px solid #eef2f7;}
    .bar>div{height:100%;background: rgba(37,99,235,.35);}
    .backdrop{
      position:fixed;inset:0;background: rgba(17,24,39,.45);
      display:none;align-items:flex-end;justify-content:center;
      z-index:80;padding: 10px 10px calc(10px + var(--safeB));
    }
    .sheet{
      width:min(560px, 100%);background:#fff;border-radius:18px;border:1px solid var(--line);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .sheet .shd{
      padding:12px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
    }
    .sheet .shd h4{margin:0;font-size:14px}
    .sheet .shd p{margin:4px 0 0;font-size:12px;color:var(--muted);line-height:1.4}
    .sheet .sbd{padding:12px}
    .closebtn{width:34px;height:34px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;}
    .sheet ul{margin:8px 0 0 18px;color:var(--muted);line-height:1.6;font-size:12px}
    .sheet ol{margin:8px 0 0 18px;color:var(--muted);line-height:1.6;font-size:12px}
    .toast{
      position:fixed;left:50%;bottom: calc(74px + var(--safeB));
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);color:#fff;padding:10px 12px;border-radius:14px;
      display:none;font-size:13px;max-width:min(560px, 92vw);z-index:90;
    }
    .miniTable{width:100%;border-collapse:separate;border-spacing:0 8px}
    .miniTable td,.miniTable th{font-size:12px;color:var(--muted);padding:8px 10px}
    .miniTable th{color:#111827;text-align:left}
    .miniRow{border:1px solid var(--line);border-radius:12px;background:#fff}
    .right{text-align:right}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:12px}
    .table th{text-align:left;color:#111827}
    .table td{color:var(--muted)}
    
    @media (max-width: 375px) {
      .appbar{
        padding: calc(10px + var(--safeT)) 12px 10px;
      }
      .title h1{font-size:15px}
      .title p{font-size:11px}
      .iconbtn{
        width:36px;height:36px;border-radius:12px;
      }
      .icon{width:16px;height:16px}
      .content{
        padding: 12px 12px 88px;
      }
      .card{
        border-radius:16px;
        margin-bottom:12px;
      }
      .hd{
        padding:10px 12px 8px;
        gap:10px;
      }
      .hd h2{font-size:15px}
      .sub{font-size:12px;margin-top:4px}
      .bd{padding:12px}
      .grid1{gap:10px}
      .grid2{gap:10px}
      .grid3{gap:10px}
      label{font-size:12px;margin-bottom:4px}
      input,select,textarea{
        padding:8px 12px;
        border-radius:10px;
        font-size:13px;
      }
      .sep{margin:10px 0}
      .pills{gap:6px}
      .pill{
        padding:6px 12px;
        font-size:12px;
      }
      .badge{
        font-size:12px;
        padding:5px 10px;
      }
      .btn{
        padding:8px 14px;
        border-radius:12px;
        font-size:12px;
        gap:6px;
      }
      .btnrow{gap:8px;margin-top:12px}
      .tabbar{
        padding: 8px 12px calc(8px + var(--safeB));
      }
      .tabs{gap:6px}
      .tab{
        border-radius:14px;
        padding:10px 6px;
        font-size:11px;
      }
      .school{
        border-radius:14px;
        padding:12px;
        gap:10px;
      }
      .school h3{font-size:14px}
      .meta{font-size:12px;margin-top:4px}
      .sheet{border-radius:16px}
      .sheet .shd{padding:10px}
      .sheet .shd h4{font-size:13px}
      .sheet .sbd{padding:10px}
      .closebtn{width:32px;height:32px;border-radius:10px}
      .toast{
        padding:8px 10px;
        font-size:12px;
        border-radius:12px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="row">
      <div class="title">
        <h1>上海中考择校</h1>
        <p id="subtitle">目标：跟踪清单与标记</p>
      </div>
      <div class="flex">
        <button class="iconbtn" id="btnHelp" aria-label="帮助">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="iconbtn" id="btnExport" aria-label="导出">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4 15v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="content">
    <!-- TARGETS (默认首页) -->
    <section id="page-targets" class="page">
      <div class="card">
        <div class="hd">
          <div>
            <h2>上海中考志愿与录取方式（概览）</h2>
            <div class="sub">把复杂规则“拆成三步”：先看批次，再看志愿数，再看资格（到校/体艺等）。</div>
          </div>
          <button class="iconbtn" id="btnExplainZKMode" aria-label="说明">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="bd">
          <div class="hint">
            <b>1）录取按批次顺序进行：</b>先“自主招生”，再“名额分配综合评价（到区/到校）”，最后“统一招生”。<br/>
            <b>2）被前一批次录取后，后一批次志愿自动失效。</b><br/>
            <b>3）志愿填报一般在学业考试后、成绩公布前进行</b>（线上填报+线下确认）。
          </div>
          <div class="sep"></div>
          <div class="hint">
            <b>名额分配综合评价</b>分为：<b>到区</b>（面向完成中招报名的学生）与 <b>到校</b>（对“本校在籍在读满3年的应届生”等有资格限制）。<br/>
            <b>统一招生</b>通常包含多志愿（1-15志愿）与征求志愿。
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2>目标学校（跟踪清单）</h2>
            <div class="sub">只需要维护目标学校，系统用模考更新达成概率。</div>
          </div>
          <button class="iconbtn" id="btnClearTargets" aria-label="清空目标">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="bd">
          <div id="targetsSummary" class="hint"></div>
          <div class="sep"></div>
          <div id="targetsList" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>
    </section>

    <!-- FILTER (原首页) -->
    <section id="page-filter" class="page" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>孩子画像（含当前初中）</h2>
            <div class="sub">用于到校名额匹配与推荐解释。</div>
          </div>
          <button class="iconbtn" id="btnExplainProfile" aria-label="说明">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="bd">
          <div class="grid2">
            <div>
              <label>所在区</label>
              <select id="district"></select>
            </div>
            <div>
              <label>初中类型</label>
              <select id="juniorType">
                <option value="公办" selected>公办</option>
                <option value="民办">民办</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid1">
            <div>
              <label>当前初中学校（用于“到校”名额）</label>
              <select id="middleSchool"></select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid3">
            <div>
              <label>稳定分（估计）</label>
              <input id="scoreStable" type="number" value="690" min="0" max="999" />
            </div>
            <div>
              <label>上限分（估计）</label>
              <input id="scoreHigh" type="number" value="705" min="0" max="999" />
            </div>
            <div>
              <label>下限分（估计）</label>
              <input id="scoreLow" type="number" value="675" min="0" max="999" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div>
              <label>筛选：学校类型</label>
              <select id="schoolType">
                <option value="all" selected>全部</option>
                <option value="市重点">市重点</option>
                <option value="区重点">区重点</option>
                <option value="一般高中">一般高中</option>
              </select>
            </div>
            <div>
              <label>仅看：该初中“到校”有名额</label>
              <div class="pills">
                <span class="pill" id="pillOnlyHaveQuota">过滤</span>
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="hint" id="kpiLine">—</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2>推荐学校池</h2>
            <div class="sub">点“加入目标”，在「目标」页跟踪；模考录入后显示达成概率。</div>
          </div>
          <button class="iconbtn" id="btnExplainScore" aria-label="说明">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M4 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 19V9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M16 19V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 19V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="bd">

          <div id="schoolList" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>
    </section>

    <!-- MOCKS -->
    <section id="page-mocks" class="page" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>模考录入（科目结构可配置）</h2>
            <div class="sub">先维护“科目与满分”，再录入每次模考各科成绩。</div>
          </div>
          <button class="iconbtn" id="btnResetSubjectTpl" aria-label="恢复示例模板">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M3 12a9 9 0 1 0 3-6.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 4v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="bd">
          <div class="grid1">
            <div>
              <label>科目与满分（JSON，可编辑）</label>
              <textarea id="subjectJson" rows="6" class="mono" spellcheck="false"></textarea>
              <div class="hint" id="subjectSumLine"></div>
              <div class="btnrow" style="margin-top:10px">
                <button class="btn" id="btnApplySubjects">应用科目结构</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid1">
            <div>
              <label>新增一次模考</label>
              <div class="grid2">
                <input id="mockName" placeholder="例如：一模 / 二模 / 校测…" />
                <button class="btn primary" id="btnAddMock">添加</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div id="mockTableWrap"></div>
        </div>
      </div>
    </section>

    <!-- EVAL -->
    <section id="page-eval" class="page" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>目标达成可能性</h2>
            <div class="sub">基于模考总分分布估算达到各校“统一招生最低分”的概率（演示）。</div>
          </div>
          <button class="iconbtn" id="btnExplainEval" aria-label="说明">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="bd">
          <div id="evalSummary" class="hint"></div>
          <div class="sep"></div>
          <div id="evalList" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabbar">
    <div class="tabs">
      <div class="tab on" data-page="targets">目标</div>
      <div class="tab" data-page="filter">筛选</div>
      <div class="tab" data-page="mocks">模考</div>
      <div class="tab" data-page="eval">评估</div>
    </div>
  </nav>
</div>

<div class="toast" id="toast"></div>

<div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="sheet">
    <div class="shd">
      <div>
        <h4 id="sheetTitle">说明</h4>
        <p id="sheetSub">—</p>
      </div>
      <button class="closebtn" id="sheetClose" aria-label="关闭">✕</button>
    </div>
    <div class="sbd" id="sheetBody"></div>
  </div>
</div>

<script src="data.js"></script>
<script>
/* =========================
   数据处理
   ========================= */

// 初中 -> 高中 到校名额（模拟数据，实际应根据真实分配）
const TO_SCHOOL_SEATS = {
  "闵行_01": { "193": 3, "194": 6, "195": 1 },
  "闵行_02": { "193": 2, "194": 3 },
  "浦东_01": { "196": 5, "197": 1 },
  "浦东_02": { "196": 3 },
  "徐汇_01": { "198": 1 },
  "静安_01": { "199": 4 },
  "普陀_01": { "200": 5, "199": 1 },
  "宝山_01": { "201": 3, "202": 2 },
  "嘉定_01": { "203": 2 },
  "松江_01": { "204": 3 },
  "青浦_01": { "205": 2 },
  "奉贤_01": { "206": 3 },
  "金山_01": { "207": 2 },
  "崇明_01": { "208": 2 },
};

// 历史录取分数线（使用2025年数据）
const HIST_SCORELINES = {};
SCHOOLS.forEach(school => {
  if (school.scores && Object.keys(school.scores).length > 0) {
    HIST_SCORELINES[school.id] = [{year: 2025, min: Math.max(...Object.values(school.scores).map(Number))}];
  }
});

// 科目结构模板（示例，可编辑）
const DEFAULT_SUBJECTS = [
  { key:"语文", max:150 },
  { key:"数学", max:150 },
  { key:"英语", max:150 },
  { key:"物理", max:70 },
  { key:"化学", max:50 },
  { key:"道法", max:30 },
  { key:"历史", max:30 },
];

/* =========================
   本地存储模型
   ========================= */
const LS_KEY = "zk_demo_targets_v3";

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(appState));
}
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

/* =========================
   App State（默认页=targets）
   ========================= */
const appState = loadState() || {
  page:"targets",
  onlyHaveQuota:false,
  profile:{
    district:"闵行",
    juniorType:"公办",
    middleSchoolId:"mh_01",
    stable:690,
    high:705,
    low:675
  },
  targets:[
    { id: uid("t"), schoolId: 5, createdAt: Date.now() },
    { id: uid("t"), schoolId: 1, createdAt: Date.now() }
  ],
  subjects: DEFAULT_SUBJECTS,
  mocks:[]
};

/* =========================
   Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
const clamp = (n,min,max)=>Math.max(min, Math.min(max,n));

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display="none", 2200);
}
function openSheet(title, sub, html){
  $("sheetTitle").textContent = title;
  $("sheetSub").textContent = sub || "";
  $("sheetBody").innerHTML = html || "";
  $("backdrop").style.display = "flex";
  $("backdrop").setAttribute("aria-hidden","false");
}
function closeSheet(){
  $("backdrop").style.display = "none";
  $("backdrop").setAttribute("aria-hidden","true");
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){
  return escapeHtml(s).replace(/"/g,"&quot;");
}

function getToSchoolSeats(middleSchoolId, highSchoolId){
  const map = TO_SCHOOL_SEATS[middleSchoolId] || {};
  return Number(map[String(highSchoolId)] || 0);
}
function getToDistrictSeats(district, school){
  // 模拟到区名额数据
  const baseSeats = school.type === '市重点' ? 10 : school.type === '区重点' ? 5 : 2;
  return baseSeats;
}

function subjectMaxSum(){
  return (appState.subjects||[]).reduce((a,b)=>a + (Number(b.max)||0), 0);
}

/* =========================
   模考总分与统计
   ========================= */
function computeMockTotals(){
  const subs = appState.subjects || [];
  appState.mocks.forEach(m=>{
    let total = 0;
    subs.forEach(s=>{
      const v = Number((m.scores||{})[s.key] || 0);
      total += v;
    });
    m.total = Math.round(total);
  });
}
function mockStats(){
  computeMockTotals();
  const totals = appState.mocks.map(m=>Number(m.total||0)).filter(x=>Number.isFinite(x));
  if(totals.length===0){
    return { n:0, mean:null, std:null, min:null, max:null };
  }
  const mean = totals.reduce((a,b)=>a+b,0) / totals.length;
  let variance = 0;
  if(totals.length>=2){
    variance = totals.reduce((a,b)=>a + Math.pow(b-mean,2),0) / (totals.length-1);
  }else{
    variance = 64; // default 8^2
  }
  const std = Math.sqrt(variance) || 8;
  return {
    n: totals.length,
    mean,
    std: clamp(std, 4, 40),
    min: Math.min(...totals),
    max: Math.max(...totals),
  };
}

/* =========================
   概率模型
   threshold = 学校在对应区县的分数线
   ========================= */
function erf(x){
  const sign = x >= 0 ? 1 : -1;
  x = Math.abs(x);
  const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429;
  const p=0.3275911;
  const t = 1.0/(1.0+p*x);
  const y = 1.0 - (((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t)*Math.exp(-x*x);
  return sign*y;
}
function normalCdf(z){
  return 0.5*(1 + erf(z/Math.SQRT2));
}
function probMeetThreshold(mean, std, threshold){
  if(mean===null || std===null) return null;
  if(std<=0) std = 8;
  const z = (threshold - mean)/std;
  const p = 1 - normalCdf(z);
  return clamp(p, 0, 1);
}
function schoolThreshold(school){
  // 使用学校在当前区县的分数线作为门槛
  const district = appState.profile.district;
  const scores = school.scores || {};
  const districtScore = scores[district];
  if(districtScore){
    return Number(districtScore);
  }
  // 如果没有对应区县的分数线，使用所有分数线的平均值
  const allScores = Object.values(scores).map(Number).filter(score => !isNaN(score));
  if(allScores.length > 0){
    return Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length);
  }
  // 默认值
  return 680;
}
function probBadge(p){
  if(p===null || p===undefined) return `<span class="badge">—</span>`;
  const pct = Math.round(p*100);
  if(pct>=75) return `<span class="badge good">${pct}%</span>`;
  if(pct>=40) return `<span class="badge warn">${pct}%</span>`;
  return `<span class="badge bad">${pct}%</span>`;
}

/* =========================
   Render selects
   ========================= */
function renderDistrictSelect(){
  $("district").innerHTML = DISTRICTS.map(d=>`<option value="${d}">${d}</option>`).join("");
}
function renderMiddleSchools(){
  const d = $("district").value || appState.profile.district;
  const list = MIDDLE_SCHOOLS.filter(x=>x.district===d);
  const fallback = [{ id:`${d}_demo`, name:`${d}区某初中（示例占位）`, district:d }];
  const options = list.length ? list : fallback;
  $("middleSchool").innerHTML = options.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  const current = appState.profile.middleSchoolId;
  const exists = options.some(x=>x.id===current);
  $("middleSchool").value = exists ? current : options[0]?.id;
  appState.profile.middleSchoolId = $("middleSchool").value;
}

/* =========================
   Filter（原首页）
   ========================= */
function renderFilter(){
  $("district").value = appState.profile.district;
  $("juniorType").value = appState.profile.juniorType;
  $("scoreStable").value = appState.profile.stable;
  $("scoreHigh").value = appState.profile.high;
  $("scoreLow").value = appState.profile.low;
  $("pillOnlyHaveQuota").classList.toggle("on", appState.onlyHaveQuota);

  renderMiddleSchools();

  const msName = $("middleSchool").selectedOptions?.[0]?.textContent || "未选择";
  const st = mockStats();
  const stLine = st.n===0
    ? `模考：<span class="badge">未录入</span>`
    : `模考：<span class="badge good">${st.n} 次</span> · 均值 <span class="mono">${Math.round(st.mean)}</span> · 波动 <span class="mono">${st.std.toFixed(1)}</span>`;
  $("kpiLine").innerHTML = `目标学校数：<b>${appState.targets.length}</b> · 当前初中：<b>${escapeHtml(msName)}</b> · ${stLine}`;

  const schoolType = $("schoolType").value;
  const msId = appState.profile.middleSchoolId;
  const district = appState.profile.district;

  const st2 = mockStats();
  const targetSet = new Set(appState.targets.map(t=>String(t.schoolId)));

  let items = SCHOOLS
    .filter(s=> (schoolType==="all" ? true : s.type===schoolType))
    .map(s=>{
      const toSchool = getToSchoolSeats(msId, s.id);
      const toDistrict = getToDistrictSeats(district, s);
      const thr = schoolThreshold(s);
      const pMeet = (st2.n===0) ? null : probMeetThreshold(st2.mean, st2.std, thr);
      return { s, toSchool, toDistrict, thr, pMeet, targeted: targetSet.has(s.id) };
    })
    .filter(x => appState.onlyHaveQuota ? x.toSchool>0 : true)
    .sort((a,b)=> ((b.pMeet??-1) - (a.pMeet??-1)) || ((b.s.baseCut||0)-(a.s.baseCut||0)));

  const wrap = $("schoolList");
  if(items.length===0){
    wrap.innerHTML = `<div class="hint">没有符合筛选条件的学校。</div>`;
    return;
  }

  wrap.innerHTML = items.map(({s,toSchool,toDistrict,thr,pMeet,targeted})=>{
    const probChip = (pMeet===null)
      ? `<span class="badge">模考概率：—</span>`
      : `<span class="badge">模考概率：${Math.round(pMeet*100)}%</span>`;
    const barPct = clamp(Math.round((pMeet??0)*100), 0, 100);

    return `
      <div class="school">
        <div class="row">
          <div>
            <h3>${escapeHtml(s.name)}</h3>
            <div class="meta">
              类型：${escapeHtml(s.type)} · 区域：${escapeHtml(s.district)}<br/>
              2025年分数线（${appState.profile.district}）：${s.scores && s.scores[appState.profile.district] ? s.scores[appState.profile.district] : '无数据'}<br/>
              评估门槛：<span class="mono">${thr}</span>
            </div>
          </div>
          <div class="flex" style="justify-content:flex-end;flex-direction:column;align-items:flex-end">
            ${probChip}
            ${targeted ? `<span class="badge good">已加入目标</span>` : ``}
          </div>
        </div>

        <div class="pills" style="gap:6px">
          <span class="badge">${escapeHtml(s.type)}</span>
          <span class="badge warn">到区：<span class="mono">${Number(toDistrict||0)}</span></span>
          <span class="badge">到校：<span class="mono">${Number(toSchool||0)}</span></span>
        </div>

        <div>
          <div class="bar"><div style="width:${barPct}%;"></div></div>
          <div class="hint" style="margin-top:8px">模考概率基于学生历史成绩分布估算。</div>
        </div>

        <div class="btnrow">
          <button class="btn" data-act="detail" data-id="${s.id}">详情</button>
          <button class="btn primary" data-act="target" data-id="${s.id}">${targeted ? "已在目标" : "加入目标"}</button>
        </div>
      </div>
    `;
  }).join("");

  wrap.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      const school = SCHOOLS.find(x=>x.id===id);
      if(!school) return;

      const st = mockStats();
      const thr = schoolThreshold(school);
      const pMeet = (st.n===0) ? null : probMeetThreshold(st.mean, st.std, thr);
      const toSchool = getToSchoolSeats(appState.profile.middleSchoolId, id);
      const toDistrict = getToDistrictSeats(appState.profile.district, school);
      const hist = HIST_SCORELINES[id] || [];

      if(act==="detail"){
        const histRows = hist.length ? hist.map(x=>`<tr><td>${x.year}</td><td class="right"><span class="mono">${x.min}</span></td></tr>`).join("")
                                     : `<tr><td colspan="2">—</td></tr>`;
        openSheet(
          "学校详情",
          `${school.name}`,
          `
            <p class="hint"><b>学校介绍：</b><br/>${escapeHtml(school.full_type || "—")}${school.note ? ` · ${escapeHtml(school.note)}` : ''}</p>

            <div class="sep"></div>

            <div class="hint"><b>名额数量：</b></div>
            <ul>
              <li>到区（${escapeHtml(appState.profile.district)}）：<span class="mono">${Number(toDistrict||0)}</span></li>
              <li>到校（${escapeHtml($("middleSchool").selectedOptions?.[0]?.textContent || "当前初中")}）：<span class="mono">${Number(toSchool||0)}</span></li>
            </ul>

            <div class="sep"></div>

            <div class="hint"><b>2025年各区县分数线：</b></div>
            <table class="table">
              <thead><tr><th>区县</th><th class="right">分数线</th></tr></thead>
              <tbody>${Object.entries(school.scores || {}).map(([district, score]) => `<tr><td>${district}</td><td class="right"><span class="mono">${score}</span></td></tr>`).join('')}</tbody>
            </table>

            <div class="sep"></div>

            <p class="hint">
              <b>评估门槛：</b><span class="mono">${thr}</span><br/>
              <b>模考达成概率：</b>${pMeet===null ? "—（请先录入模考）" : `<span class="mono">${Math.round(pMeet*100)}%</span>`}
            </p>
          `
        );
      }

      if(act==="target"){
        const schoolIdStr = String(id);
        const exists = appState.targets.some(t=>String(t.schoolId)===schoolIdStr);
        if(exists){
          toast("已在目标清单");
          return;
        }
        appState.targets.unshift({ id: uid("t"), schoolId: schoolIdStr, createdAt: Date.now() });
        saveState();
        toast("已加入目标");
        renderAll();
      }
    });
  });
}

/* =========================
   Targets
   ========================= */
function renderTargetsPage(){
  const st = mockStats();
  const sum = subjectMaxSum();
  const msName = MIDDLE_SCHOOLS.find(x=>x.id===appState.profile.middleSchoolId)?.name || "未选择";
  const d = appState.profile.district;

  $("targetsSummary").innerHTML =
    `当前初中：<b>${escapeHtml(msName)}</b> · 目标数：<b>${appState.targets.length}</b><br/>` +
    (st.n===0
      ? `模考：<span class="badge">未录入</span>（去「模考」页录入后可看到达成概率）`
      : `模考：<span class="badge good">${st.n}次</span>（总分满分 <span class="mono">${sum}</span>），均值 <span class="mono">${Math.round(st.mean)}</span>，波动 <span class="mono">${st.std.toFixed(1)}</span>`);

  const wrap = $("targetsList");
  if(appState.targets.length===0){
    wrap.innerHTML = `<div class="hint">还没有目标学校。去「筛选」页点“加入目标”。</div>`;
    return;
  }

  const rows = appState.targets.map(t=>{
    const schoolId = String(t.schoolId);
    const s = SCHOOLS.find(x=>x.id===schoolId);
    if(!s) return null;
    const thr = schoolThreshold(s);
    const p = (st.n===0) ? null : probMeetThreshold(st.mean, st.std, thr);
    const toSchool = getToSchoolSeats(appState.profile.middleSchoolId, s.id);
    const toDistrict = getToDistrictSeats(d, s);
    return { t, s, thr, p, toSchool, toDistrict };
  }).filter(Boolean);

  rows.sort((a,b)=>{
    if(st.n>0) return (a.p??0) - (b.p??0);
    return (b.s.baseCut||0) - (a.s.baseCut||0);
  });

  wrap.innerHTML = rows.map(({t,s,thr,p,toSchool,toDistrict})=>{
    const barPct = clamp(Math.round((p??0)*100), 0, 100);
    return `
      <div class="school">
        <div class="row">
          <div>
            <h3>${escapeHtml(s.name)}</h3>
            <div class="meta">类型：${escapeHtml(s.type)} · 统一最低分（示例）：${s.baseCut} · 评估门槛：<span class="mono">${thr}</span></div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <span class="badge">达成</span> ${probBadge(p)}
          </div>
        </div>

        <div class="pills" style="gap:6px">
          <span class="badge good">自招：<span class="mono">${Number(s.zhaojiao||0)}</span></span>
          <span class="badge warn">到区：<span class="mono">${Number(toDistrict||0)}</span></span>
          <span class="badge">到校：<span class="mono">${Number(toSchool||0)}</span></span>
        </div>

        <div>
          <div class="bar"><div style="width:${barPct}%;"></div></div>
        </div>

        <div class="btnrow">
          <button class="btn" data-act="detail" data-sid="${s.id}">详情</button>
          <button class="btn danger" data-act="rmTarget" data-id="${t.id}">移除</button>
        </div>
      </div>
    `;
  }).join("");

  wrap.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      if(act==="rmTarget"){
        const id = btn.getAttribute("data-id");
        appState.targets = appState.targets.filter(x=>x.id!==id);
        saveState();
        toast("已移除目标");
        renderAll();
        return;
      }
      if(act==="detail"){
        const sid = Number(btn.getAttribute("data-sid"));
        const school = SCHOOLS.find(x=>x.id===sid);
        if(!school) return;

        const st = mockStats();
        const thr = schoolThreshold(school);
        const pMeet = (st.n===0) ? null : probMeetThreshold(st.mean, st.std, thr);
        const toSchool = getToSchoolSeats(appState.profile.middleSchoolId, sid);
        const toDistrict = getToDistrictSeats(appState.profile.district, school);
        const hist = HIST_SCORELINES[String(sid)] || [];
        const histRows = hist.length ? hist.map(x=>`<tr><td>${x.year}</td><td class="right"><span class="mono">${x.min}</span></td></tr>`).join("")
                                     : `<tr><td colspan="2">—</td></tr>`;

        openSheet(
          "学校详情（示例）",
          `${school.name}`,
          `
            <p class="hint"><b>学校介绍：</b><br/>${escapeHtml(school.intro || "—")}</p>

            <div class="sep"></div>

            <div class="hint"><b>名额数量（示例）：</b></div>
            <ul>
              <li>自招：<span class="mono">${Number(school.zhaojiao||0)}</span></li>
              <li>到区（${escapeHtml(appState.profile.district)}）：<span class="mono">${Number(toDistrict||0)}</span></li>
              <li>到校（${escapeHtml(msName)}）：<span class="mono">${Number(toSchool||0)}</span></li>
            </ul>

            <div class="sep"></div>

            <div class="hint"><b>历史录取分数线（统一招生最低分，示例）：</b></div>
            <table class="table">
              <thead><tr><th>年份</th><th class="right">最低分</th></tr></thead>
              <tbody>${histRows}</tbody>
            </table>

            <div class="sep"></div>

            <p class="hint">
              <b>评估门槛（演示）：</b><span class="mono">${thr}</span><br/>
              <b>模考达成概率（演示）：</b>${pMeet===null ? "—（请先录入模考）" : `<span class="mono">${Math.round(pMeet*100)}%</span>`}
            </p>
          `
        );
      }
    });
  });
}

/* =========================
   Mocks
   ========================= */
function updateSubjectSumLine(){
  $("subjectSumLine").innerHTML = `当前总分：<span class="mono">${subjectMaxSum()}</span>（示例可改） · 模考会按此结构计算总分`;
}
function applySubjectsFromJson(){
  try{
    const arr = JSON.parse($("subjectJson").value);
    if(!Array.isArray(arr) || arr.length===0) throw new Error("JSON必须是数组");
    arr.forEach(x=>{
      if(!x.key || typeof x.key!=="string") throw new Error("每项需包含 key（科目名）");
      if(!Number.isFinite(Number(x.max))) throw new Error("每项需包含 max（满分数字）");
    });
    appState.subjects = arr.map(x=>({ key:String(x.key), max:Number(x.max) }));
    appState.mocks.forEach(m=>{
      m.scores = m.scores || {};
      appState.subjects.forEach(s=>{
        if(m.scores[s.key]===undefined) m.scores[s.key] = 0;
      });
    });
    saveState();
    toast("已应用科目结构");
    renderAll();
  }catch(e){
    toast("科目JSON有误：" + e.message);
  }
}
function addMock(){
  const name = ($("mockName").value || "").trim() || ("模考" + (appState.mocks.length+1));
  const id = uid("mock");
  const scores = {};
  (appState.subjects||[]).forEach(s=> scores[s.key] = 0);
  appState.mocks.unshift({ id, name, scores, total: 0 });
  $("mockName").value = "";
  saveState();
  toast("已添加");
  renderAll();
}
function renderMocksPage(){
  $("subjectJson").value = JSON.stringify(appState.subjects, null, 2);
  updateSubjectSumLine();

  computeMockTotals();
  const subs = appState.subjects || [];
  const mocks = appState.mocks || [];
  const wrap = $("mockTableWrap");

  if(mocks.length===0){
    wrap.innerHTML = `<div class="hint">还没有模考。上方输入名称后点“添加”。</div>`;
    return;
  }

  wrap.innerHTML = `
    <div class="hint" style="margin-bottom:8px">填写各科分数（自动算总分）。建议录入 ≥3 次，概率估计更稳定。</div>
    <div style="overflow:auto;-webkit-overflow-scrolling:touch">
      <table class="miniTable">
        <thead>
          <tr>
            <th style="min-width:140px">模考</th>
            ${subs.map(s=>`<th class="right" style="min-width:90px">${escapeHtml(s.key)}<div class="muted">/${s.max}</div></th>`).join("")}
            <th class="right" style="min-width:90px">总分</th>
            <th style="min-width:90px">操作</th>
          </tr>
        </thead>
        <tbody>
          ${mocks.map(m=>{
            return `
              <tr class="miniRow">
                <td><b>${escapeHtml(m.name)}</b></td>
                ${subs.map(s=>{
                  const v = Number((m.scores||{})[s.key] || 0);
                  return `<td class="right">
                    <input data-mock="${m.id}" data-sub="${escapeAttr(s.key)}" type="number" min="0" max="${s.max}" value="${v}" style="padding:8px 10px;text-align:right"/>
                  </td>`;
                }).join("")}
                <td class="right"><span class="mono">${m.total||0}</span></td>
                <td><button class="btn danger" data-act="delMock" data-id="${m.id}" style="padding:8px 10px;border-radius:12px">删除</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;

  const st = mockStats();
  const sum = subjectMaxSum();
  const statLine = (st.n===0) ? "" : `
    <div class="sep"></div>
    <div class="hint">
      统计（总分 / 满分 ${sum}）：均值 <span class="mono">${Math.round(st.mean)}</span> · 波动 <span class="mono">${st.std.toFixed(1)}</span> · 区间 <span class="mono">${st.min}~${st.max}</span>
    </div>
  `;
  wrap.innerHTML += statLine;

  wrap.querySelectorAll("input[data-mock]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const mid = inp.getAttribute("data-mock");
      const sub = inp.getAttribute("data-sub");
      const m = appState.mocks.find(x=>x.id===mid);
      if(!m) return;
      const max = Number(appState.subjects.find(s=>s.key===sub)?.max || 999);
      const v = clamp(Number(inp.value||0), 0, max);
      m.scores = m.scores || {};
      m.scores[sub] = v;
      saveState();
      renderAll();
    });
  });

  wrap.querySelectorAll('button[data-act="delMock"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      appState.mocks = appState.mocks.filter(x=>x.id!==id);
      saveState();
      toast("已删除");
      renderAll();
    });
  });
}

/* =========================
   Eval
   ========================= */
function renderEvalPage(){
  const st = mockStats();
  const sum = subjectMaxSum();

  $("evalSummary").innerHTML = st.n===0
    ? `尚未录入模考：请先去「模考」页录入。`
    : `基于 <span class="badge good">${st.n} 次模考</span>（满分 <span class="mono">${sum}</span>），均值 <span class="mono">${Math.round(st.mean)}</span>，波动 <span class="mono">${st.std.toFixed(1)}</span>，区间 <span class="mono">${st.min}~${st.max}</span>。`;

  const wrap = $("evalList");
  if(appState.targets.length===0){
    wrap.innerHTML = `<div class="hint">没有目标学校可评估。去「筛选」/「目标」添加。</div>`;
    return;
  }

  const rows = appState.targets.map(t=>{
    const s = SCHOOLS.find(x=>x.id===Number(t.schoolId));
    if(!s) return null;
    const thr = schoolThreshold(s);
    const p = (st.n===0) ? null : probMeetThreshold(st.mean, st.std, thr);
    return { t, s, thr, p };
  }).filter(Boolean);

  let atLeastOne = null;
  if(st.n>0){
    atLeastOne = 1;
    rows.forEach(x=>{
      atLeastOne *= (1 - (x.p ?? 0));
    });
    atLeastOne = 1 - atLeastOne;
  }

  rows.sort((a,b)=>{
    if(st.n>0) return (a.p??0) - (b.p??0);
    return (b.thr - a.thr);
  });

  const header = st.n===0 ? "" : `
    <div class="school">
      <div class="row">
        <div>
          <h3>整体指标（演示）</h3>
          <div class="meta">独立性假设下的“至少达成一所目标”的合成概率（仅用于展示）。</div>
        </div>
        <div class="flex" style="justify-content:flex-end">
          <span class="badge">至少一所</span> ${probBadge(atLeastOne)}
        </div>
      </div>
    </div>
    <div class="sep"></div>
  `;

  const list = rows.map(x=>{
    const pct = (x.p===null) ? 0 : Math.round(x.p*100);
    const barPct = clamp(pct, 0, 100);
    return `
      <div class="school">
        <div class="row">
          <div>
            <h3>${escapeHtml(x.s.name)}</h3>
            <div class="meta">评估门槛：<span class="mono">${x.thr}</span></div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <span class="badge">达成</span> ${probBadge(x.p)}
          </div>
        </div>
        <div>
          <div class="bar"><div style="width:${barPct}%;"></div></div>
        </div>
      </div>
    `;
  }).join("");

  wrap.innerHTML = header + list;
}

/* =========================
   Navigation
   ========================= */
function setPage(page){
  appState.page = page;
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("on", t.getAttribute("data-page") === page);
  });
  ["targets","filter","mocks","eval"].forEach(p=>{
    document.getElementById("page-"+p).style.display = (p===page) ? "" : "none";
  });

  $("subtitle").textContent =
    page==="targets" ? "目标：跟踪清单与标记"
    : page==="filter" ? "筛选：推荐学校池（加入目标）"
    : page==="mocks" ? "模考：科目结构与多次录入"
    : "评估：目标达成可能性";

  if(page==="targets") renderTargetsPage();
  if(page==="filter") renderFilter();
  if(page==="mocks") renderMocksPage();
  if(page==="eval") renderEvalPage();

  saveState();
}

/* =========================
   Bind
   ========================= */
function bind(){
  $("sheetClose").addEventListener("click", closeSheet);
  $("backdrop").addEventListener("click", (e)=>{ if(e.target===$("backdrop")) closeSheet(); });
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeSheet(); });

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=> setPage(t.getAttribute("data-page")));
  });

  $("btnHelp").addEventListener("click", ()=>{
    openSheet("使用方式", "目标学校跟踪 + 模考评估", `
      <ol>
        <li>先在「目标」页明确：你要追踪哪些学校（冲/稳/保）。</li>
        <li>去「筛选」页调整区/初中等条件，把学校加入目标。</li>
        <li>去「模考」页录入多次模考。</li>
        <li>在「评估」页查看每个目标的达成概率（演示）。</li>
      </ol>
      <div class="sep"></div>
      <p class="hint"><b>说明：</b>本Demo的名额与分数线为示例；概率模型为演示。真实产品建议按位次/排名建模并做批次规则模拟。</p>
    `);
  });

  $("btnExplainZKMode").addEventListener("click", ()=>{
    openSheet("上海中考模式（大致逻辑）", "用于产品引导文案（概览）", `
      <p class="hint">
        <b>核心思路：</b>把“复杂规则”拆成「批次顺序 + 志愿数量 + 资格条件」三件事。
      </p>
      <div class="sep"></div>
      <div class="hint"><b>一、三大录取批次（按顺序）</b></div>
      <ul>
        <li><b>自主招生：</b>市实验/市特色等自招；体艺骨干等（需资格）；国际课程/合作办学通常另有流程；中职校自主招生（中本贯通/五年一贯制/中高职贯通/提前招生等）。</li>
        <li><b>名额分配综合评价：</b>包含<b>到区</b>与<b>到校</b>（到校通常对“本校在籍在读满3年的应届生”等有资格限制）。</li>
        <li><b>统一招生：</b>面向完成中招报名的学生，通常设置多志愿（示例：1-15志愿）+ 征求志愿。</li>
      </ul>
      <div class="sep"></div>
      <div class="hint"><b>二、志愿填报节奏（常见）</b></div>
      <ul>
        <li>一般在学业考试后、成绩发布前：线上填报 + 线下确认。</li>
        <li>若在前一批次已被录取，后一批次志愿将自然失效。</li>
      </ul>
      <div class="sep"></div>
      <p class="hint">
        <b>产品落地建议：</b>把每个目标学校拆成“可参与的批次/志愿栏位/资格限制/历史分数线/名额数量”，让家长一眼看懂“我能报什么、怎么报、概率如何”。
      </p>
    `);
  });

  $("btnExplainProfile").addEventListener("click", ()=>{
    openSheet("为什么要选当前初中？", "到校名额依赖初中维度", `
      <ul>
        <li>“到校”名额按<b>初中</b>分配到高中。</li>
        <li>同区同分，不同初中可冲的目标不同。</li>
      </ul>
    `);
  });

  $("btnExplainScore").addEventListener("click", ()=>{
    openSheet("概率与门槛说明", "演示模型口径", `
      <ul>
        <li>用模考总分样本估计均值/波动。</li>
        <li>评估门槛 = 统一最低分（示例） + 波动修正。</li>
        <li>估算 P(总分 ≥ 评估门槛)。</li>
      </ul>
    `);
  });

  $("btnExplainEval").addEventListener("click", ()=>{
    openSheet("评估页说明", "怎么用它？", `
      <ul>
        <li>单校：看“达成概率”随模考变化。</li>
        <li>整体：给“至少一所目标达成”的合成概率（仅演示）。</li>
      </ul>
    `);
  });

  $("btnExport").addEventListener("click", ()=>{
    const text = JSON.stringify(appState, null, 2);
    navigator.clipboard?.writeText(text).then(()=>{
      toast("已复制当前数据 JSON（含目标与模考）");
    }).catch(()=>{
      openSheet("导出数据（JSON）", "浏览器不允许自动复制，手动复制即可。", `<textarea class="mono" style="width:100%;height:280px">${text}</textarea>`);
    });
  });

  // filter inputs
  $("district").addEventListener("change", ()=>{
    appState.profile.district = $("district").value;
    renderMiddleSchools();
    saveState();
    renderAll();
  });
  $("juniorType").addEventListener("change", ()=>{
    appState.profile.juniorType = $("juniorType").value;
    saveState(); renderAll();
  });
  $("middleSchool").addEventListener("change", ()=>{
    appState.profile.middleSchoolId = $("middleSchool").value;
    saveState(); renderAll();
  });
  ["scoreStable","scoreHigh","scoreLow"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      appState.profile.stable = Number($("scoreStable").value||0);
      appState.profile.high = Number($("scoreHigh").value||0);
      appState.profile.low = Number($("scoreLow").value||0);
      saveState(); renderAll();
    });
  });

  $("schoolType").addEventListener("change", ()=>{ saveState(); renderAll(); });

  $("pillOnlyHaveQuota").addEventListener("click", ()=>{
    appState.onlyHaveQuota = !appState.onlyHaveQuota;
    $("pillOnlyHaveQuota").classList.toggle("on", appState.onlyHaveQuota);
    saveState();
    renderAll();
  });

  // targets clear
  $("btnClearTargets").addEventListener("click", ()=>{
    if(appState.targets.length===0){ toast("目标清单为空"); return; }
    openSheet("清空目标学校？", "将移除全部目标（本地存储）", `
      <p class="hint">当前目标数：<b>${appState.targets.length}</b></p>
      <div class="btnrow" style="margin-top:10px">
        <button class="btn" id="btnCancel">取消</button>
        <button class="btn danger" id="btnOK">确认清空</button>
      </div>
    `);
    setTimeout(()=>{
      $("btnCancel").onclick = closeSheet;
      $("btnOK").onclick = ()=>{
        appState.targets = [];
        saveState();
        closeSheet();
        toast("已清空");
        renderAll();
      };
    },0);
  });

  // mocks
  $("btnApplySubjects").addEventListener("click", applySubjectsFromJson);
  $("btnAddMock").addEventListener("click", addMock);
  $("btnResetSubjectTpl").addEventListener("click", ()=>{
    appState.subjects = DEFAULT_SUBJECTS;
    saveState();
    toast("已恢复示例模板");
    renderAll();
  });
}

/* =========================
   Render all
   ========================= */
function renderAll(){
  // filter页面依赖select渲染
  if($("district")) renderDistrictSelect();
  if(appState.page==="targets") renderTargetsPage();
  if(appState.page==="filter") renderFilter();
  if(appState.page==="mocks") renderMocksPage();
  if(appState.page==="eval") renderEvalPage();
}

/* =========================
   Init
   ========================= */
(function init(){
  // filter controls init (即使不在筛选页也先初始化，避免切换时报错)
  renderDistrictSelect();
  $("district").value = appState.profile.district;
  $("subjectJson").value = JSON.stringify(appState.subjects, null, 2);
  updateSubjectSumLine();
  renderMiddleSchools();

  bind();
  setPage(appState.page || "targets");
  renderAll();
})();
</script>
</body>
</html>
