<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>上海中考AI择校</title>
  <style>
    :root {
      --bg: #f6f7f9;
      --bg-2: #f2f4f7;
      --surface: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f2937;
      --brand-2: #111827;
      --accent: #0f766e;
      --good: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 16px 30px rgba(17, 24, 39, .08);
      --shadow-soft: 0 4px 12px rgba(17, 24, 39, .06);
      --r: 18px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --tap: rgba(15, 118, 110, .12);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font-sans: "IBM Plex Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans CJK SC", sans-serif;
      --font-display: "IBM Plex Serif", "Songti SC", "STSong", serif;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      background:
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
    }

    body:before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .25;
      background-image:
        linear-gradient(90deg, rgba(17, 24, 39, .035) 1px, transparent 1px),
        linear-gradient(rgba(17, 24, 39, .035) 1px, transparent 1px);
      background-size: 28px 28px;
      mix-blend-mode: multiply;
      z-index: 0;
    }

    button,
    input,
    select,
    textarea {
      font: inherit
    }

    .app {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1
    }

    .appbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(250, 251, 252, .92);
      backdrop-filter: saturate(180%) blur(14px);
      border-bottom: 1px solid var(--line);
      padding: calc(14px + var(--safeT)) 18px 12px;
      box-shadow: 0 6px 16px rgba(17, 24, 39, .06);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .title h1 {
      margin: 0;
      font-size: 17px;
      letter-spacing: .2px;
      font-family: var(--font-display)
    }

    .title p {
      margin: 0;
      font-size: 12px;
      color: var(--muted)
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: rgba(17, 24, 39, .04);
      border: 1px solid rgba(17, 24, 39, .08);
      box-shadow: var(--shadow-soft);
      color: var(--brand);
    }

    .iconbtn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(17, 24, 39, .08);
      background: rgba(255, 255, 255, .9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-soft);
    }

    .iconbtn:hover {
      border-color: rgba(17, 24, 39, .16);
      transform: translateY(-1px);
    }

    .iconbtn:active {
      transform: scale(.98);
      background: var(--tap)
    }

    .icon {
      width: 18px;
      height: 18px;
      display: block
    }

    .content {
      flex: 1 1 auto;
      padding: 18px 18px 96px;
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border: 1px solid rgba(17, 24, 39, .08);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 18px;
      transition: all 0.22s ease;
      animation: rise .5s ease both;
    }

    .card:hover {
      box-shadow: 0 20px 46px rgba(15, 23, 42, .12);
    }

    .hd {
      padding: 14px 18px 12px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, .95), rgba(255, 255, 255, 0));
    }

    .hgroup {
      display: flex;
      gap: 12px;
      align-items: flex-start
    }

    .card-ico {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: rgba(17, 24, 39, .04);
      border: 1px solid rgba(17, 24, 39, .12);
      color: var(--brand);
      flex: 0 0 auto;
    }

    .hd h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600
    }

    .sub {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5
    }

    .bd {
      padding: 14px 16px
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6
    }

    .sep {
      height: 1px;
      background: var(--line);
      margin: 14px 0
    }

    .grid1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px
    }

    .grid3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px
    }

    .profile-grid {
      display: grid;
      gap: 10px;
      margin-bottom: 12px
    }

    .profile-grid--two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr))
    }

    .profile-grid--three {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr))
    }

    .profile-grid--four {
      grid-template-columns: repeat(4, 1fr)
    }

    .profile-grid--full {
      grid-template-columns: 1fr
    }

    .profile-grid.align-end {
      align-items: end
    }

    .metric-card {
      border: 1px solid rgba(17, 24, 39, .08);
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(17, 24, 39, .03);
      text-align: center;
    }

    .metric-label {
      display: block;
      font-size: 10px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 6px;
      text-align: center;
    }

    .metric-card input {
      all: unset;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .03em;
      color: #111827;
      line-height: 1.2;
      width: 100%;
    }

    .kpi-overview {
      border: 0;
      padding: 0;
      background: transparent;
      min-height: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin: 0 0 4px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(17, 24, 39, .12);
      border-radius: 12px;
      background: #fff;
      outline: none;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    input:hover,
    select:hover,
    textarea:hover {
      border-color: rgba(17, 24, 39, .2);
      box-shadow: 0 4px 10px rgba(17, 24, 39, .08);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(15, 118, 110, .55);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, .16);
    }

    .pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      padding: 6px 12px;
      border: 1px solid rgba(17, 24, 39, .12);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
      user-select: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .pill:hover {
      border-color: rgba(17, 24, 39, .2);
      box-shadow: var(--shadow-soft);
    }

    .pill.on {
      border-color: rgba(15, 118, 110, .45);
      background: rgba(15, 118, 110, .12);
      color: var(--brand);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(17, 24, 39, .12);
      background: #fff;
      color: var(--muted);
      white-space: nowrap;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .badge:hover {
      transform: translateY(-1px);
    }

    .badge.good {
      border-color: rgba(22, 163, 74, .3);
      background: rgba(22, 163, 74, .12);
      color: var(--good)
    }

    .badge.warn {
      border-color: rgba(245, 158, 11, .3);
      background: rgba(245, 158, 11, .15);
      color: var(--warn)
    }

    .badge.bad {
      border-color: rgba(239, 68, 68, .3);
      background: rgba(239, 68, 68, .15);
      color: var(--bad)
    }

    .mono {
      font-family: var(--mono)
    }

    .btn {
      border: 1px solid rgba(17, 24, 39, .12);
      background: #fff;
      padding: 8px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: all 0.2s ease;
      gap: 6px;
      font-weight: 600;
    }

    .btn:hover {
      border-color: rgba(17, 24, 39, .2);
      box-shadow: var(--shadow-soft);
    }

    .btn:active {
      transform: scale(.98);
      background: var(--tap)
    }

    .btn.primary {
      border-color: rgba(15, 118, 110, .4);
      background: rgba(15, 118, 110, .14);
      color: var(--brand);
    }

    .btn.primary:hover {
      background: rgba(15, 118, 110, .2);
      border-color: rgba(15, 118, 110, .5);
    }

    .btn.success {
      border-color: rgba(22, 163, 74, .35);
      background: rgba(22, 163, 74, .12);
      color: #166534;
    }

    .btn.success:hover {
      background: rgba(22, 163, 74, .18);
      border-color: rgba(22, 163, 74, .45);
    }

    .btn.danger {
      border-color: rgba(239, 68, 68, .3);
      background: rgba(239, 68, 68, .12);
      color: var(--bad);
    }

    .btn.danger:hover {
      background: rgba(239, 68, 68, .18);
      border-color: rgba(239, 68, 68, .4);
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btnrow {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 16px
    }

    .tabbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 16px calc(10px + var(--safeB));
      background: rgba(250, 251, 252, .96);
      backdrop-filter: saturate(180%) blur(16px);
      border-top: 1px solid var(--line);
      z-index: 30;
      box-shadow: 0 -6px 16px rgba(17, 24, 39, .08);
    }

    .tabs {
      max-width: 600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .tab {
      border-radius: 14px;
      padding: 10px 8px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      user-select: none;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      font-weight: 600;
      background: rgba(255, 255, 255, .7);
    }

    .tab:hover {
      background: rgba(17, 24, 39, .04);
    }

    .tab:active {
      transform: scale(0.98);
    }

    .tab.on {
      color: var(--brand);
      background: rgba(15, 118, 110, .16);
      border-color: rgba(15, 118, 110, .35);
      font-weight: 700;
    }

    .school {
      border: 1px solid rgba(17, 24, 39, .1);
      border-radius: 16px;
      padding: 16px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-soft);
    }

    .school:hover {
      box-shadow: 0 10px 20px rgba(17, 24, 39, .1);
    }

    .school-head {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start
    }

    .school-title {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: .01em
    }

    .school-sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5
    }

    .school-tag {
      display: inline-flex;
      align-items: center;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(17, 24, 39, .12);
      background: rgba(17, 24, 39, .03);
      color: #111827;
    }

    .school-status {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(17, 24, 39, .12);
      background: #fff;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .04em;
      line-height: 1.1;
    }

    .status-pill strong {
      color: #111827;
      font-weight: 700
    }

    .status-pill.good {
      border-color: rgba(22, 163, 74, .3);
      background: rgba(22, 163, 74, .12);
      color: var(--good)
    }

    .status-pill.warn {
      border-color: rgba(245, 158, 11, .3);
      background: rgba(245, 158, 11, .15);
      color: var(--warn)
    }

    .status-pill.bad {
      border-color: rgba(239, 68, 68, .3);
      background: rgba(239, 68, 68, .15);
      color: var(--bad)
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .metric {
      padding: 8px 10px;
      border: 1px solid rgba(17, 24, 39, .1);
      border-radius: 10px;
      background: rgba(17, 24, 39, .02);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .metric-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      font-weight: 700;
    }

    .metric-value {
      font-size: 12px;
      color: #111827;
      font-weight: 700;
    }

    .school-progress {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .school-note {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6
    }

    .school-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap
    }

    .bar {
      height: 10px;
      border-radius: 999px;
      background: #eef2f7;
      overflow: hidden;
      border: 1px solid #e6edf5;
    }

    .bar>div {
      height: 100%;
      background: linear-gradient(90deg, rgba(15, 118, 110, .5), rgba(15, 118, 110, .2));
    }

    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, .45);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 80;
      padding: 10px 10px calc(10px + var(--safeB));
    }

    .sheet {
      width: min(560px, 100%);
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(17, 24, 39, .1);
      box-shadow: var(--shadow);
      overflow: hidden;
      max-height: 86vh;
      display: flex;
      flex-direction: column;
    }

    .sheet .shd {
      padding: 12px 14px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255, 255, 255, .95), rgba(255, 255, 255, 0));
    }

    .sheet .shd h4 {
      margin: 0;
      font-size: 14px
    }

    .sheet .shd p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4
    }

    .sheet .sbd {
      padding: 12px 14px;
      overflow: auto;
      flex: 1 1 auto
    }

    .closebtn {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(17, 24, 39, .12);
      background: #fff;
      cursor: pointer;
    }

    .sheet ul {
      margin: 8px 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 12px
    }

    .sheet ol {
      margin: 8px 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 12px
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(74px + var(--safeB));
      transform: translateX(-50%);
      background: rgba(17, 24, 39, .92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      display: none;
      font-size: 13px;
      max-width: min(560px, 92vw);
      z-index: 90;
    }

    .miniTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px
    }

    .miniTable thead th {
      font-size: 13px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      padding: 6px 8px;
      text-align: center;
      background: linear-gradient(180deg, rgba(248, 250, 252, .95), rgba(248, 250, 252, .7));
      border: 1px solid rgba(17, 24, 39, .06);
      white-space: nowrap;
    }

    .miniTable thead th:first-child {
      border-radius: 8px 0 0 8px;
      width: 90px
    }

    .miniTable thead th:last-child {
      border-radius: 0 8px 8px 0;
      width: 130px
    }

    .miniTable thead th.right {
      text-align: center
    }

    .miniTable td {
      font-size: 13px;
      color: #334155;
      padding: 10px 12px;
      background: #fff;
      border-top: 1px solid rgba(17, 24, 39, .06);
      border-bottom: 1px solid rgba(17, 24, 39, .06);
      white-space: nowrap;
      text-align: center;
    }

    .miniTable td:first-child {
      border-left: 1px solid rgba(17, 24, 39, .06);
      border-radius: 8px 0 0 8px
    }

    .miniTable td:last-child {
      border-right: 1px solid rgba(17, 24, 39, .06);
      border-radius: 0 8px 8px 0
    }

    .miniTable td:first-child:last-child {
      border-radius: 8px
    }

    .miniTable td.mono {
      font-family: var(--mono);
      font-weight: 600;
      color: #0f172a
    }

    .miniTable tr:hover td {
      background: linear-gradient(90deg, rgba(15, 118, 110, .03), rgba(15, 118, 110, .01))
    }

    .miniRow {
      border: 1px solid rgba(17, 24, 39, .08);
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(17, 24, 39, .04)
    }

    .right {
      text-align: right
    }

    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .muted {
      color: var(--muted)
    }

    .table {
      width: 100%;
      border-collapse: collapse
    }

    .table th,
    .table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      font-size: 12px
    }

    .table th {
      text-align: left;
      color: #0f172a
    }

    .table td {
      color: var(--muted)
    }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 375px) {
      .appbar {
        padding: calc(12px + var(--safeT)) 12px 10px;
      }

      .title h1 {
        font-size: 16px
      }

      .title p {
        font-size: 11px
      }

      .brand-mark {
        width: 32px;
        height: 32px;
        border-radius: 10px
      }

      .iconbtn {
        width: 36px;
        height: 36px;
        border-radius: 12px;
      }

      .icon {
        width: 16px;
        height: 16px
      }

      .content {
        padding: 12px 12px 88px;
      }

      .card {
        border-radius: 18px;
        margin-bottom: 14px;
      }

      .hd {
        padding: 10px 12px 8px;
        gap: 10px;
      }

      .hd h2 {
        font-size: 15px
      }

      .sub {
        font-size: 12px;
        margin-top: 4px
      }

      .bd {
        padding: 12px
      }

      .grid1 {
        gap: 8px
      }

      .grid2 {
        gap: 8px
      }

      .grid3 {
        gap: 8px
      }

      .profile-grid {
        gap: 8px;
        margin-bottom: 10px
      }

      label {
        font-size: 10px;
        margin-bottom: 4px
      }

      input,
      select,
      textarea {
        padding: 7px 10px;
        border-radius: 10px;
        font-size: 12px;
      }

      .sep {
        margin: 10px 0
      }

      .pills {
        gap: 6px
      }

      .pill {
        padding: 6px 12px;
        font-size: 11px;
        letter-spacing: .05em;
        min-height: 28px;
      }

      .badge {
        font-size: 11px;
        padding: 5px 10px;
        letter-spacing: .04em;
        min-height: 26px;
      }

      .btn {
        padding: 7px 12px;
        border-radius: 12px;
        font-size: 11px;
        gap: 6px;
        letter-spacing: .06em;
        min-height: 32px;
      }

      .btnrow {
        gap: 8px;
        margin-top: 12px
      }

      .tabbar {
        padding: 8px 12px calc(8px + var(--safeB));
      }

      .tabs {
        gap: 6px
      }

      .tab {
        border-radius: 12px;
        padding: 8px 6px;
        font-size: 10px;
        letter-spacing: .06em;
        min-height: 32px;
      }

      .school {
        border-radius: 14px;
        padding: 12px;
        gap: 10px;
      }

      .school-title {
        font-size: 14px;
        letter-spacing: .01em
      }

      .school-sub {
        font-size: 11px;
        margin-top: 4px
      }

      .metrics {
        gap: 6px
      }

      .metric {
        padding: 6px 8px
      }

      .metric-label {
        font-size: 9px;
        letter-spacing: .08em
      }

      .metric-value {
        font-size: 11px
      }

      .metric-card {
        padding: 6px 8px
      }

      .metric-card input {
        font-size: 16px
      }

      .sheet {
        border-radius: 16px
      }

      .sheet .shd {
        padding: 10px
      }

      .sheet .shd h4 {
        font-size: 13px
      }

      .sheet .sbd {
        padding: 10px
      }

      .closebtn {
        width: 32px;
        height: 32px;
        border-radius: 10px
      }

      .toast {
        padding: 8px 10px;
        font-size: 12px;
        border-radius: 12px;
      }
    }

    .fab {
      position: fixed;
      right: 20px;
      bottom: calc(80px + var(--safeB));
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0f766e, #115e59);
      border: none;
      box-shadow: 0 8px 24px rgba(15, 118, 110, .35);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 35;
      transition: all 0.3s cubic-bezier(.34, 1.56, .64, 1);
    }

    .fab:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 32px rgba(15, 118, 110, .4);
    }

    .fab:active {
      transform: scale(0.95);
    }

    @media (max-width: 375px) {
      .fab {
        width: 48px;
        height: 48px;
        right: 16px;
        bottom: calc(74px + var(--safeB));
      }

      .miniTable {
        border-spacing: 0 4px
      }

      .miniTable thead th {
        font-size: 10px;
        padding: 5px 6px
      }

      .miniTable thead th:first-child {
        border-radius: 6px 0 0 6px
      }

      .miniTable thead th:last-child {
        border-radius: 0 6px 6px 0
      }

      .miniTable td {
        font-size: 12px;
        padding: 8px 10px
      }

      .miniTable td:first-child {
        border-radius: 6px 0 0 6px
      }

      .miniTable td:last-child {
        border-radius: 0 6px 6px 0
      }

      .miniTable td:first-child:last-child {
        border-radius: 6px
      }

      .profile-grid--four {
        grid-template-columns: repeat(2, 1fr)
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="appbar">
      <div class="row">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M4 16c0-4 3-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M6 16c1.5 2 3.7 3 6 3s4.5-1 6-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M12 4v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </div>
          <div class="title">
            <h1>上海中考择校</h1>
            <p id="subtitle">目标：跟踪清单与标记</p>
          </div>
        </div>
        <div class="flex">
          <button class="iconbtn" id="btnHelp" aria-label="帮助">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2" />
              <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
            </svg>
          </button>
          <button class="iconbtn" id="btnExport" aria-label="导出">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M4 15v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <main class="content">
      <!-- TARGETS (默认首页) -->
      <section id="page-targets" class="page">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <div class="card-ico" aria-hidden="true">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M6 5h8a4 4 0 0 1 4 4v10H8a2 2 0 0 1-2-2V5Z" stroke="currentColor" stroke-width="2"
                    stroke-linejoin="round" />
                  <path d="M6 5v12a2 2 0 0 0 2 2h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M9 9h6M9 13h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>
              <div>
                <h2>上海中考志愿与录取方式</h2>
                <div class="sub">三步走：自招，到区/到校，平行志愿</div>
              </div>
            </div>
            <button class="iconbtn" id="btnExplainZKMode" aria-label="说明">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2" />
                <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
              </svg>
            </button>
          </div>
          <div class="bd">
            <div class="hint">
              <b>1）录取按批次顺序进行：</b>先“自主招生”，再“名额分配综合评价（到区/到校）”，最后“统一招生”。<br />
              <b>2）被前一批次录取后，后一批次志愿自动失效。</b><br />
              <b>3）志愿填报一般在学业考试后、成绩公布前进行</b>（线上填报+线下确认）。
            </div>
            <div class="sep"></div>
            <div class="hint">
              <b>名额分配综合评价</b>分为：<b>到区</b>（面向完成中招报名的学生）与 <b>到校</b>（对“本校在籍在读满3年的应届生”等有资格限制）。<br />
              <b>统一招生</b>通常包含多志愿（1-15志愿）与征求志愿。
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <div class="card-ico" aria-hidden="true">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M12 5v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M12 16v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M5 12h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M16 12h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2" />
                </svg>
              </div>
              <div>
                <h2>目标学校（跟踪清单）</h2>
                <div class="sub">目标学校，用模考评估达成概率</div>
              </div>
            </div>
            <button class="iconbtn" id="btnClearTargets" aria-label="清空目标">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </div>
          <div class="bd">
            <div id="targetsSummary" class="hint"></div>
            <div class="sep"></div>
            <div id="targetsList" style="display:flex;flex-direction:column;gap:10px"></div>
          </div>
        </div>
      </section>

      <!-- FILTER (原首页) -->
      <section id="page-filter" class="page" style="display:none">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <div class="card-ico" aria-hidden="true">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="8" r="3.5" stroke="currentColor" stroke-width="2" />
                  <path d="M4.5 19.5c1.8-3.2 4.2-5 7.5-5s5.7 1.8 7.5 5" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" />
                </svg>
              </div>
              <div>
                <h2>孩子画像（含当前初中）</h2>
                <div class="sub">用于到校名额匹配与推荐解释。</div>
              </div>
            </div>
            <button class="iconbtn" id="btnExplainProfile" aria-label="说明">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2" />
                <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
              </svg>
            </button>
          </div>
          <div class="bd">
            <div class="profile-grid profile-grid--two">
              <div>
                <label>所在区</label>
                <select id="district"></select>
              </div>
              <div>
                <label>初中类型</label>
                <select id="juniorType">
                  <option value="公办" selected>公办</option>
                  <option value="民办">民办</option>
                </select>
              </div>
            </div>

            <div class="profile-grid profile-grid--full">
              <div>
                <label>当前初中学校（用于“到校”名额）</label>
                <select id="middleSchool"></select>
              </div>
            </div>

            <div class="profile-grid" style="display:flex;gap:10px;">
              <div class="metric-card" style="flex:1;">
                <span class="metric-label">稳定分（估计）</span>
                <input id="scoreStable" class="metric-input mono" type="number" value="690" min="0" max="999" />
              </div>
              <div class="metric-card" style="flex:1;">
                <span class="metric-label">上限分（估计）</span>
                <input id="scoreHigh" class="metric-input mono" type="number" value="705" min="0" max="999" />
              </div>
              <div class="metric-card" style="flex:1;">
                <span class="metric-label">下限分（估计）</span>
                <input id="scoreLow" class="metric-input mono" type="number" value="675" min="0" max="999" />
              </div>
            </div>

            <div class="profile-grid profile-grid--full">
              <div>
                <label>筛选：学校类型</label>
                <select id="schoolType">
                  <option value="all" selected>全部</option>
                  <option value="市重点">市重点</option>
                  <option value="区重点">区重点</option>
                  <option value="一般高中">一般高中</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <div class="card-ico" aria-hidden="true">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M4 7h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M4 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <circle cx="18" cy="7" r="3" stroke="currentColor" stroke-width="2" />
                </svg>
              </div>
              <div>
                <h2>推荐学校池</h2>
                <div class="sub">"加入目标"跟踪达成概率</div>
              </div>
            </div>
            <button class="iconbtn" id="btnExplainScore" aria-label="说明">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M4 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M8 19V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M12 19V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M16 19V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M20 19V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </div>
          <div class="bd">

            <div id="schoolList" style="display:flex;flex-direction:column;gap:10px"></div>
          </div>
        </div>
      </section>

      <!-- MOCKS -->
      <section id="page-mocks" class="page" style="display:none">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <div class="card-ico" aria-hidden="true">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M6 4h9l3 3v13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Z" stroke="currentColor"
                    stroke-width="2" stroke-linejoin="round" />
                  <path d="M15 4v4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M8 12h8M8 16h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>
              <div>
                <h2>模考记录</h2>
                <div class="sub">点击下方按钮添加模考成绩</div>
              </div>
            </div>
          </div>
          <div class="bd">
            <div id="mockTableWrap"></div>
          </div>
        </div>
        <button class="fab" id="btnAddMockFloating" aria-label="添加模考">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </section>

      <!-- EVAL -->
      <section id="page-eval" class="page" style="display:none">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <div class="card-ico" aria-hidden="true">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M5 16l4-4 3 3 6-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                  <path d="M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>
              <div>
                <h2>目标达成可能性</h2>
                <div class="sub">基于模考总分分布估算达到各校“统一招生最低分”的概率（演示）。</div>
              </div>
            </div>
            <button class="iconbtn" id="btnExplainEval" aria-label="说明">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2" />
                <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
              </svg>
            </button>
          </div>
          <div class="bd">
            <div id="evalSummary" class="hint"></div>
            <div class="sep"></div>
            <div id="evalList" style="display:flex;flex-direction:column;gap:10px"></div>
          </div>
        </div>
      </section>
    </main>

    <nav class="tabbar">
      <div class="tabs">
        <div class="tab on" data-page="targets">目标</div>
        <div class="tab" data-page="filter">筛选</div>
        <div class="tab" data-page="mocks">模考</div>
        <div class="tab" data-page="eval">评估</div>
      </div>
    </nav>
  </div>

  <div class="toast" id="toast"></div>

  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="shd">
        <div>
          <h4 id="sheetTitle">说明</h4>
          <p id="sheetSub">—</p>
        </div>
        <button class="closebtn" id="sheetClose" aria-label="关闭">✕</button>
      </div>
      <div class="sbd" id="sheetBody"></div>
    </div>
  </div>

  <!-- 模考录入弹框 -->
  <div class="backdrop" id="mockModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet" style="max-height:90vh;">
      <div class="shd">
        <div>
          <h4 id="mockModalTitle">添加模考</h4>
          <p id="mockModalSub">填写模考名称和各科成绩</p>
        </div>
        <button class="closebtn" id="mockModalClose" aria-label="关闭">✕</button>
      </div>
      <div class="sbd" style="padding:16px;">
        <div class="grid1">
          <div>
            <label>模考名称</label>
            <input id="mockModalName" placeholder="例如：一模 / 二模 / 校测…" />
          </div>
        </div>

        <div class="sep" style="margin:16px 0;"></div>

        <div id="mockModalSubjects" style="display:flex;flex-direction:column;gap:12px;">
          <!-- 科目输入框将通过 JavaScript 动态生成 -->
        </div>

        <div class="btnrow" style="margin-top:20px;">
          <button class="btn" id="mockModalCancel">取消</button>
          <button class="btn primary" id="mockModalSave">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="data.js"></script>
  <script>
    /* =========================
       数据处理
       ========================= */

    // 初中 -> 高中 到校名额（模拟数据，实际应根据真实分配）
    const TO_SCHOOL_SEATS = {
      "闵行_01": { "193": 3, "194": 6, "195": 1 },
      "闵行_02": { "193": 2, "194": 3 },
      "浦东_01": { "196": 5, "197": 1 },
      "浦东_02": { "196": 3 },
      "徐汇_01": { "198": 1 },
      "静安_01": { "199": 4 },
      "普陀_01": { "200": 5, "199": 1 },
      "宝山_01": { "201": 3, "202": 2 },
      "嘉定_01": { "203": 2 },
      "松江_01": { "204": 3 },
      "青浦_01": { "205": 2 },
      "奉贤_01": { "206": 3 },
      "金山_01": { "207": 2 },
      "崇明_01": { "208": 2 },
    };

    // 历史录取分数线（使用2025年数据）
    const HIST_SCORELINES = {};
    SCHOOLS.forEach(school => {
      if (school.scores && Object.keys(school.scores).length > 0) {
        HIST_SCORELINES[school.id] = [{ year: 2025, min: Math.max(...Object.values(school.scores).map(Number)) }];
      }
    });

    // 科目结构模板（示例，可编辑）
    const DEFAULT_SUBJECTS = [
      { key: "语文", max: 150 },
      { key: "数学", max: 150 },
      { key: "英语", max: 150 },
      { key: "物理", max: 70 },
      { key: "化学", max: 50 },
      { key: "道法", max: 30 },
      { key: "历史", max: 30 },
    ];

    /* =========================
       本地存储模型
       ========================= */
    const LS_KEY = "zk_demo_targets_v3";

    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }
    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify(appState));
    }
    function uid(prefix = "id") {
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    /* =========================
       App State（默认页=targets）
       ========================= */
    const appState = loadState() || {
      page: "targets",
      profile: {
        district: "闵行",
        juniorType: "公办",
        middleSchoolId: "mh_01",
        stable: 690,
        high: 705,
        low: 675
      },
      targets: [
        { id: uid("t"), schoolId: 5, createdAt: Date.now() },
        { id: uid("t"), schoolId: 1, createdAt: Date.now() }
      ],
      subjects: DEFAULT_SUBJECTS,
      mocks: []
    };

    /* =========================
       Helpers
       ========================= */
    const $ = (id) => document.getElementById(id);
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    function toast(msg) {
      const el = $("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.style.display = "none", 2200);
    }
    function openSheet(title, sub, html) {
      $("sheetTitle").textContent = title;
      $("sheetSub").textContent = sub || "";
      $("sheetBody").innerHTML = html || "";
      $("backdrop").style.display = "flex";
      $("backdrop").setAttribute("aria-hidden", "false");
    }
    function closeSheet() {
      $("backdrop").style.display = "none";
      $("backdrop").setAttribute("aria-hidden", "true");
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
    }
    function escapeAttr(s) {
      return escapeHtml(s).replace(/"/g, "&quot;");
    }

    function getToSchoolSeats(middleSchoolId, highSchoolId) {
      const map = TO_SCHOOL_SEATS[middleSchoolId] || {};
      return Number(map[String(highSchoolId)] || 0);
    }
    function getToDistrictSeats(district, school) {
      // 模拟到区名额数据
      const baseSeats = school.type === '市重点' ? 10 : school.type === '区重点' ? 5 : 2;
      return baseSeats;
    }

    function subjectMaxSum() {
      return (appState.subjects || []).reduce((a, b) => a + (Number(b.max) || 0), 0);
    }

    /* =========================
       模考总分与统计
       ========================= */
    function computeMockTotals() {
      const subs = appState.subjects || [];
      appState.mocks.forEach(m => {
        let total = 0;
        subs.forEach(s => {
          const v = Number((m.scores || {})[s.key] || 0);
          total += v;
        });
        m.total = Math.round(total);
      });
    }
    function mockStats() {
      computeMockTotals();
      const totals = appState.mocks.map(m => Number(m.total || 0)).filter(x => Number.isFinite(x) && x > 0);
      if (totals.length === 0) {
        return { n: 0, mean: null, std: null, min: null, max: null, median: null };
      }
      const mean = totals.reduce((a, b) => a + b, 0) / totals.length;
      let variance = 0;
      if (totals.length >= 2) {
        variance = totals.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (totals.length - 1);
      } else {
        // 当只有一个样本时，根据分数范围动态设置方差
        const scoreRange = subjectMaxSum();
        variance = Math.pow(scoreRange * 0.05, 2); // 默认使用总分的5%作为标准差
      }
      const std = Math.sqrt(variance) || 8;
      const sorted = [...totals].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      const median = sorted.length % 2 ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
      return {
        n: totals.length,
        mean,
        std: clamp(std, 4, 40),
        min: Math.min(...totals),
        max: Math.max(...totals),
        median
      };
    }

    /* =========================
       概率模型
       threshold = 学校在对应区县的分数线
       ========================= */
    function erf(x) {
      const sign = x >= 0 ? 1 : -1;
      x = Math.abs(x);
      const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429;
      const p = 0.3275911;
      const t = 1.0 / (1.0 + p * x);
      const y = 1.0 - (((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t) * Math.exp(-x * x);
      return sign * y;
    }
    function normalCdf(z) {
      return 0.5 * (1 + erf(z / Math.SQRT2));
    }
    function probMeetThreshold(mean, std, threshold) {
      if (mean === null || std === null) return null;
      if (std <= 0) std = 8;

      // 考虑满分差异，对分数线进行调整
      const userMaxScore = subjectMaxSum();
      const standardMaxScore = 750; // 上海中考满分约750分

      // 调整后的分数线
      const adjustedThreshold = (threshold / standardMaxScore) * userMaxScore;

      const z = (adjustedThreshold - mean) / std;
      // 优化概率计算，确保极端情况下的准确性
      let p;
      if (z > 6) {
        p = 0; // z值大于6时，概率几乎为0
      } else if (z < -6) {
        p = 1; // z值小于-6时，概率几乎为1
      } else {
        p = 1 - normalCdf(z);
      }
      return clamp(p, 0, 1);
    }
    function schoolThreshold(school) {
      // 使用学校在当前区县的分数线作为门槛
      const district = appState.profile.district;
      const scores = school.scores || {};
      const districtScore = scores[district];
      if (districtScore) {
        return Number(districtScore);
      }
      // 如果没有对应区县的分数线，使用所有分数线的平均值
      const allScores = Object.values(scores).map(Number).filter(score => !isNaN(score) && score > 0);
      if (allScores.length > 0) {
        const avgScore = allScores.reduce((a, b) => a + b, 0) / allScores.length;
        return Math.round(avgScore);
      }
      // 根据学校类型设置默认值
      if (school.type === '市重点') {
        return 700;
      } else if (school.type === '区重点') {
        return 670;
      } else {
        return 640;
      }
    }
    function probBadge(p) {
      if (p === null || p === undefined) return `<span class="badge">—</span>`;
      const pct = Math.round(p * 100);
      if (pct >= 75) return `<span class="badge good">${pct}%</span>`;
      if (pct >= 40) return `<span class="badge warn">${pct}%</span>`;
      return `<span class="badge bad">${pct}%</span>`;
    }
    function probCategory(p) {
      if (p === null || p === undefined) return { label: "—", cls: "" };
      const pct = Math.round(p * 100);
      if (pct >= 75) return { label: "保", cls: "good" };
      if (pct >= 40) return { label: "稳", cls: "warn" };
      return { label: "冲", cls: "bad" };
    }

    /* =========================
       Render selects
       ========================= */
    function renderDistrictSelect() {
      $("district").innerHTML = DISTRICTS.map(d => `<option value="${d}">${d}</option>`).join("");
    }
    function renderMiddleSchools() {
      const d = $("district").value || appState.profile.district;
      const list = MIDDLE_SCHOOLS.filter(x => x.district === d);
      const fallback = [{ id: `${d}_demo`, name: `${d}区某初中（示例占位）`, district: d }];
      const options = list.length ? list : fallback;
      $("middleSchool").innerHTML = options.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
      const current = appState.profile.middleSchoolId;
      const exists = options.some(x => x.id === current);
      $("middleSchool").value = exists ? current : options[0]?.id;
      appState.profile.middleSchoolId = $("middleSchool").value;
    }

    /* =========================
       Filter（原首页）
       ========================= */
    function renderFilter() {
      $("district").value = appState.profile.district;
      $("juniorType").value = appState.profile.juniorType;
      $("scoreStable").value = appState.profile.stable;
      $("scoreHigh").value = appState.profile.high;
      $("scoreLow").value = appState.profile.low;

      renderMiddleSchools();

      const msName = $("middleSchool").selectedOptions?.[0]?.textContent || "未选择";

      const schoolType = $("schoolType").value;
      const msId = appState.profile.middleSchoolId;
      const district = appState.profile.district;

      const st2 = mockStats();
      const targetSet = new Set(appState.targets.map(t => String(t.schoolId)));

      let items = SCHOOLS
        .filter(s => (schoolType === "all" ? true : s.type === schoolType))
        .map(s => {
          const toSchool = getToSchoolSeats(msId, s.id);
          const toDistrict = getToDistrictSeats(district, s);
          const thr = schoolThreshold(s);
          const pMeet = (st2.n === 0) ? null : probMeetThreshold(st2.mean, st2.std, thr);
          return { s, toSchool, toDistrict, thr, pMeet, targeted: targetSet.has(s.id) };
        })
        .sort((a, b) => ((b.pMeet ?? -1) - (a.pMeet ?? -1)) || ((b.s.baseCut || 0) - (a.s.baseCut || 0)));

      const wrap = $("schoolList");
      if (items.length === 0) {
        wrap.innerHTML = `<div class="hint">没有符合筛选条件的学校。</div>`;
        return;
      }

      wrap.innerHTML = items.map(({ s, toSchool, toDistrict, thr, pMeet, targeted }) => {
        const probText = (pMeet === null) ? "—" : `${Math.round(pMeet * 100)}%`;
        const probClass = (pMeet === null) ? "" : (pMeet >= 0.75 ? "good" : (pMeet >= 0.4 ? "warn" : "bad"));
        const probPill = `<span class="status-pill ${probClass}">模考概率 <strong>${probText}</strong></span>`;
        const barPct = clamp(Math.round((pMeet ?? 0) * 100), 0, 100);
        const districtScore = s.scores && s.scores[appState.profile.district] ? s.scores[appState.profile.district] : "无数据";

        return `
      <div class="school">
        <div class="school-head">
          <div>
            <div class="school-title">${escapeHtml(s.name)}</div>
            <div class="school-sub">区域：${escapeHtml(s.district)} · 类型：${escapeHtml(s.type)}</div>
          </div>
          <div class="school-status">
            ${probPill}
          </div>
        </div>

        <div class="metrics">
          <div class="metric"><span class="metric-label">${escapeHtml(appState.profile.district)}到区</span><span class="metric-value mono">${districtScore}</span></div>
          <div class="metric"><span class="metric-label">到校分数</span><span class="metric-value mono">${thr}</span></div>
          <div class="metric"><span class="metric-label">到区名额</span><span class="metric-value mono">${Number(toDistrict || 0)}</span></div>
          <div class="metric"><span class="metric-label">到校名额</span><span class="metric-value mono">${Number(toSchool || 0)}</span></div>
        </div>

        <div class="school-progress">
          <div class="bar"><div style="width:${barPct}%;"></div></div>
          <div class="school-note">模考概率基于学生历史成绩分布估算。</div>
        </div>

        <div class="school-actions">
          <button class="btn" data-act="detail" data-id="${s.id}">详情</button>
          <button class="btn ${targeted ? "success" : "primary"}" data-act="target" data-id="${s.id}" ${targeted ? "disabled" : ""}>${targeted ? "已在目标" : "加入目标"}</button>
        </div>
      </div>
    `;
      }).join("");

      wrap.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          const school = SCHOOLS.find(x => x.id === id);
          if (!school) return;

          const st = mockStats();
          const thr = schoolThreshold(school);
          const pMeet = (st.n === 0) ? null : probMeetThreshold(st.mean, st.std, thr);
          const toSchool = getToSchoolSeats(appState.profile.middleSchoolId, id);
          const toDistrict = getToDistrictSeats(appState.profile.district, school);
          const hist = HIST_SCORELINES[id] || [];

          if (act === "detail") {
            const histRows = hist.length ? hist.map(x => `<tr><td>${x.year}</td><td class="right"><span class="mono">${x.min}</span></td></tr>`).join("")
              : `<tr><td colspan="2">—</td></tr>`;
            openSheet(
              "学校详情",
              `${school.name}`,
              `
            <p class="hint"><b>学校介绍：</b><br/>${escapeHtml(school.full_type || "—")}${school.note ? ` · ${escapeHtml(school.note)}` : ''}</p>

            <div class="sep"></div>

            <div class="hint"><b>名额数量：</b></div>
            <ul>
              <li>到区（${escapeHtml(appState.profile.district)}）：<span class="mono">${Number(toDistrict || 0)}</span></li>
              <li>到校（${escapeHtml($("middleSchool").selectedOptions?.[0]?.textContent || "当前初中")}）：<span class="mono">${Number(toSchool || 0)}</span></li>
            </ul>

            <div class="sep"></div>

            <div class="hint"><b>2025年各区县分数线：</b></div>
            <table class="table">
              <thead><tr><th>区县</th><th class="right">分数线</th></tr></thead>
              <tbody>${Object.entries(school.scores || {}).map(([district, score]) => `<tr><td>${district}</td><td class="right"><span class="mono">${score}</span></td></tr>`).join('')}</tbody>
            </table>

            <div class="sep"></div>

            <p class="hint">
              <b>评估门槛：</b><span class="mono">${thr}</span><br/>
              <b>模考达成概率：</b>${pMeet === null ? "—（请先录入模考）" : `<span class="mono">${Math.round(pMeet * 100)}%</span>`}
            </p>
          `
            );
          }

          if (act === "target") {
            const schoolIdStr = String(id);
            const exists = appState.targets.some(t => String(t.schoolId) === schoolIdStr);
            if (exists) {
              toast("已在目标清单");
              return;
            }
            appState.targets.unshift({ id: uid("t"), schoolId: schoolIdStr, createdAt: Date.now() });
            saveState();
            toast("已加入目标");
            renderAll();
          }
        });
      });
    }

    /* =========================
       Targets
       ========================= */
    function renderTargetsPage() {
      const st = mockStats();
      const sum = subjectMaxSum();
      const msName = MIDDLE_SCHOOLS.find(x => x.id === appState.profile.middleSchoolId)?.name || "未选择";
      const d = appState.profile.district;

      $("targetsSummary").innerHTML =
        `当前初中：<b>${escapeHtml(msName)}</b> · 目标数：<b>${appState.targets.length}</b><br/>` +
        (st.n === 0
          ? `模考：<span class="badge">未录入</span>（去「模考」页录入后可看到达成概率）`
          : `模考：<span class="badge good">${st.n}次</span>（总分满分 <span class="mono">${sum}</span>），均值 <span class="mono">${Math.round(st.mean)}</span>，波动 <span class="mono">${st.std.toFixed(1)}</span>`);

      const wrap = $("targetsList");
      if (appState.targets.length === 0) {
        wrap.innerHTML = `<div class="hint">还没有目标学校。去「筛选」页点“加入目标”。</div>`;
        return;
      }

      const rows = appState.targets.map(t => {
        const schoolId = String(t.schoolId);
        const s = SCHOOLS.find(x => x.id === schoolId);
        if (!s) return null;
        const thr = schoolThreshold(s);
        const p = (st.n === 0) ? null : probMeetThreshold(st.mean, st.std, thr);
        const toSchool = getToSchoolSeats(appState.profile.middleSchoolId, s.id);
        const toDistrict = getToDistrictSeats(d, s);
        return { t, s, thr, p, toSchool, toDistrict };
      }).filter(Boolean);

      rows.sort((a, b) => {
        if (st.n > 0) return (a.p ?? 0) - (b.p ?? 0);
        return (b.s.baseCut || 0) - (a.s.baseCut || 0);
      });

      wrap.innerHTML = rows.map(({ t, s, thr, p, toSchool, toDistrict }) => {
        const barPct = clamp(Math.round((p ?? 0) * 100), 0, 100);
        const probText = (p === null) ? "—" : `${Math.round((p ?? 0) * 100)}%`;
        const probClass = (p === null) ? "" : (p >= 0.75 ? "good" : (p >= 0.4 ? "warn" : "bad"));
        const districtScore = s.scores && s.scores[appState.profile.district] ? s.scores[appState.profile.district] : "无数据";
        return `
      <div class="school">
        <div class="school-head">
          <div>
            <div class="school-title">${escapeHtml(s.name)}</div>
            <div class="school-sub">区域：${escapeHtml(s.district)} · 类型：${escapeHtml(s.type)}</div>
          </div>
          <div class="school-status">
            <span class="status-pill ${probClass}">模考概率 <strong>${probText}</strong></span>
          </div>
        </div>

        <div class="metrics">
          <div class="metric"><span class="metric-label">${escapeHtml(appState.profile.district)}到区</span><span class="metric-value mono">${districtScore}</span></div>
          <div class="metric"><span class="metric-label">到校分数</span><span class="metric-value mono">${thr}</span></div>
          <div class="metric"><span class="metric-label">到区名额</span><span class="metric-value mono">${Number(toDistrict || 0)}</span></div>
          <div class="metric"><span class="metric-label">到校名额</span><span class="metric-value mono">${Number(toSchool || 0)}</span></div>
        </div>

        <div class="school-progress">
          <div class="bar"><div style="width:${barPct}%;"></div></div>
          <div class="school-note">模考概率基于学生历史成绩分布估算。</div>
        </div>

        <div class="school-actions">
          <button class="btn" data-act="detail" data-sid="${s.id}">详情</button>
          <button class="btn danger" data-act="rmTarget" data-id="${t.id}">移除</button>
        </div>
      </div>
    `;
      }).join("");

      wrap.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          if (act === "rmTarget") {
            const id = btn.getAttribute("data-id");
            appState.targets = appState.targets.filter(x => x.id !== id);
            saveState();
            toast("已移除目标");
            renderAll();
            return;
          }
          if (act === "detail") {
            const sid = btn.getAttribute("data-sid");
            const school = SCHOOLS.find(x => String(x.id) === String(sid));
            if (!school) return;

            const st = mockStats();
            const thr = schoolThreshold(school);
            const pMeet = (st.n === 0) ? null : probMeetThreshold(st.mean, st.std, thr);
            const toSchool = getToSchoolSeats(appState.profile.middleSchoolId, sid);
            const toDistrict = getToDistrictSeats(appState.profile.district, school);
            const hist = HIST_SCORELINES[String(sid)] || [];
            const histRows = hist.length ? hist.map(x => `<tr><td>${x.year}</td><td class="right"><span class="mono">${x.min}</span></td></tr>`).join("")
              : `<tr><td colspan="2">—</td></tr>`;

            openSheet(
              "学校详情（示例）",
              `${school.name}`,
              `
            <p class="hint"><b>学校介绍：</b><br/>${escapeHtml(school.intro || "—")}</p>

            <div class="sep"></div>

            <div class="hint"><b>名额数量（示例）：</b></div>
            <ul>
              <li>自招：<span class="mono">${Number(school.zhaojiao || 0)}</span></li>
              <li>到区（${escapeHtml(appState.profile.district)}）：<span class="mono">${Number(toDistrict || 0)}</span></li>
              <li>到校（${escapeHtml(msName)}）：<span class="mono">${Number(toSchool || 0)}</span></li>
            </ul>

            <div class="sep"></div>

            <div class="hint"><b>历史录取分数线（统一招生最低分，示例）：</b></div>
            <table class="table">
              <thead><tr><th>年份</th><th class="right">最低分</th></tr></thead>
              <tbody>${histRows}</tbody>
            </table>

            <div class="sep"></div>

            <p class="hint">
              <b>评估门槛（演示）：</b><span class="mono">${thr}</span><br/>
              <b>模考达成概率（演示）：</b>${pMeet === null ? "—（请先录入模考）" : `<span class="mono">${Math.round(pMeet * 100)}%</span>`}
            </p>
          `
            );
          }
        });
      });
    }

    /* =========================
       Mocks
       ========================= */
    function updateSubjectSumLine() {
      $("subjectSumLine").innerHTML = `当前总分：<span class="mono">${subjectMaxSum()}</span>（示例可改） · 模考会按此结构计算总分`;
    }
    function applySubjectsFromJson() {
      try {
        const arr = JSON.parse($("subjectJson").value);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("JSON必须是数组");
        arr.forEach(x => {
          if (!x.key || typeof x.key !== "string") throw new Error("每项需包含 key（科目名）");
          if (!Number.isFinite(Number(x.max))) throw new Error("每项需包含 max（满分数字）");
        });
        appState.subjects = arr.map(x => ({ key: String(x.key), max: Number(x.max) }));
        appState.mocks.forEach(m => {
          m.scores = m.scores || {};
          appState.subjects.forEach(s => {
            if (m.scores[s.key] === undefined) m.scores[s.key] = 0;
          });
        });
        saveState();
        toast("已应用科目结构");
        renderAll();
      } catch (e) {
        toast("科目JSON有误：" + e.message);
      }
    }
    // 模考弹框功能
    function openMockModal() {
      $("mockModalName").value = "";

      const subjectsContainer = $("mockModalSubjects");
      subjectsContainer.innerHTML = "";

      appState.subjects.forEach(subject => {
        const div = document.createElement("div");
        div.className = "grid2";
        div.innerHTML = `
      <div>
        <label>${subject.key}（满分${subject.max}）</label>
        <input type="number" id="mockScore_${subject.key}" min="0" max="${subject.max}" placeholder="输入分数" />
      </div>
    `;
        subjectsContainer.appendChild(div);
      });

      $("mockModal").style.display = "flex";
      $("mockModal").setAttribute("aria-hidden", "false");
    }

    function closeMockModal() {
      $("mockModal").style.display = "none";
      $("mockModal").setAttribute("aria-hidden", "true");
    }

    function saveMock() {
      const name = $("mockModalName").value.trim();
      if (!name) {
        toast("请输入模考名称");
        return;
      }

      const scores = {};
      let hasValidScore = false;

      appState.subjects.forEach(subject => {
        const input = document.getElementById(`mockScore_${subject.key}`);
        const score = Number(input.value) || 0;
        scores[subject.key] = score;
        if (score > 0) hasValidScore = true;
      });

      if (!hasValidScore) {
        toast("请至少输入一个科目分数");
        return;
      }

      // 检查是否是编辑现有模考
      const existingMock = appState.mocks.find(m => m.name === name);
      if (existingMock) {
        existingMock.scores = scores;
        existingMock.createdAt = Date.now();
      } else {
        const newMock = {
          id: uid("mock"),
          name: name,
          scores: scores,
          createdAt: Date.now()
        };
        appState.mocks.push(newMock);
      }

      computeMockTotals();
      saveState();
      renderMocksPage();
      closeMockModal();
      toast("模考保存成功");
    }

    function renderMocksPage() {
      computeMockTotals();
      const subs = appState.subjects || [];
      const mocks = appState.mocks || [];
      const wrap = $("mockTableWrap");

      if (mocks.length === 0) {
        wrap.innerHTML = `<div class="hint">还没有模考。点击右下角按钮添加模考成绩。</div>`;
        return;
      }

      wrap.innerHTML = `
    <div class="hint" style="margin-bottom:8px">建议录入 ≥3 次，概率估计更稳定。</div>
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
      <table class="miniTable" style="width:auto;min-width:100%">
        <thead>
          <tr>
            <th>操作</th>
            <th class="right">总分</th>
            <th>模考</th>
            ${subs.map(s => `<th class="right">${escapeHtml(s.key)}</th>`).join("")}
          </tr>
        </thead>
        <tbody>
          ${mocks.map(m => {
        return `
              <tr>
                <td>
                  <button class="btn" data-act="editMock" data-id="${m.id}" style="padding:6px 10px;border-radius:10px;font-size:11px">修改</button>
                  <button class="btn danger" data-act="delMock" data-id="${m.id}" style="padding:6px 10px;border-radius:10px;font-size:11px">删除</button>
                </td>
                <td class="mono right">${m.total || 0}</td>
                <td><b>${escapeHtml(m.name)}</b></td>
                ${subs.map(s => {
          const v = Number((m.scores || {})[s.key] || 0);
          return `<td class="mono right">${v}</td>`;
        }).join("")}
              </tr>
            `;
      }).join("")}
        </tbody>
      </table>
    </div>
  `;

      const st = mockStats();
      const sum = subjectMaxSum();
      const statLine = (st.n === 0) ? "" : `
    <div class="sep"></div>
    <div class="profile-grid profile-grid--four" style="margin-top:12px">
      <div class="metric-card">
        <span class="metric-label">满分</span>
        <span class="mono" style="font-size:18px;font-weight:700;color:#0f172a">${sum}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">平均分</span>
        <span class="mono" style="font-size:18px;font-weight:700;color:#0f766e">${appState.profile.stable}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">上限分</span>
        <span class="mono" style="font-size:18px;font-weight:700;color:#f59e0b">${appState.profile.high}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">下限分</span>
        <span class="mono" style="font-size:18px;font-weight:700;color:#64748b">${appState.profile.low}</span>
      </div>
    </div>
  `;
      wrap.innerHTML += statLine;

      wrap.querySelectorAll('button[data-act="editMock"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const mock = appState.mocks.find(x => x.id === id);
          if (!mock) return;

          $("mockModalName").value = mock.name;
          const subjectsContainer = $("mockModalSubjects");
          subjectsContainer.innerHTML = appState.subjects.map(s => `
        <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:rgba(17,24,39,.03);border-radius:12px;">
          <span style="font-size:13px;font-weight:600;min-width:60px;">${s.key}</span>
          <input type="number" id="mockScore_${s.key}" min="0" max="${s.max}" placeholder="0" value="${(mock.scores || {})[s.key] || ''}" style="flex:1;text-align:right;padding:10px 14px;font-size:15px;border-radius:10px;" />
          <span style="font-size:12px;color:var(--muted);min-width:30px;">/ ${s.max}</span>
        </div>
      `).join("");
          $("mockModal").style.display = "flex";
          $("mockModal").setAttribute("aria-hidden", "false");
          $("mockModalName").focus();
        });
      });

      wrap.querySelectorAll('button[data-act="delMock"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          appState.mocks = appState.mocks.filter(x => x.id !== id);
          saveState();
          toast("已删除");
          renderAll();
        });
      });
    }

    /* =========================
       Eval
       ========================= */
    function renderEvalPage() {
      const st = mockStats();
      const sum = subjectMaxSum();

      $("evalSummary").innerHTML = st.n === 0
        ? `尚未录入模考：请先去「模考」页录入。`
        : `样本 <span class="badge good">${st.n}</span> · 满分 <span class="mono">${sum}</span> · 均值 <span class="mono">${Math.round(st.mean)}</span> · 中位数 <span class="mono">${st.median}</span> · 波动 <span class="mono">${st.std.toFixed(1)}</span> · 区间 <span class="mono">${st.min}~${st.max}</span>`;

      const wrap = $("evalList");
      if (appState.targets.length === 0) {
        wrap.innerHTML = `<div class="hint">没有目标学校可评估。去「筛选」/「目标」添加。</div>`;
        return;
      }

      const rows = appState.targets.map(t => {
        const schoolIdStr = String(t.schoolId);
        const s = SCHOOLS.find(x => x.id === schoolIdStr);
        if (!s) return null;
        const thr = schoolThreshold(s);
        const p = (st.n === 0) ? null : probMeetThreshold(st.mean, st.std, thr);
        return { t, s, thr, p };
      }).filter(Boolean);

      let atLeastOne = null;
      if (st.n > 0) {
        atLeastOne = 1;
        rows.forEach(x => {
          atLeastOne *= (1 - (x.p ?? 0));
        });
        atLeastOne = 1 - atLeastOne;
      }
      const expectedCount = st.n > 0 ? rows.reduce((a, b) => a + (b.p ?? 0), 0) : null;
      const bestProb = st.n > 0 ? Math.max(...rows.map(r => r.p ?? 0)) : null;

      rows.sort((a, b) => {
        if (st.n > 0) return (a.p ?? 0) - (b.p ?? 0);
        return (b.thr - a.thr);
      });

      const header = st.n === 0 ? "" : `
    <div class="school">
      <div class="school-head">
        <div>
          <div class="school-title">整体评估</div>
          <div class="school-sub">独立性假设下的合成指标。</div>
        </div>
        <div class="school-status">
          <span class="status-pill">至少一所 <strong>${atLeastOne === null ? "—" : Math.round(atLeastOne * 100) + "%"}</strong></span>
          <span class="status-pill">期望达成数 <strong>${expectedCount === null ? "—" : expectedCount.toFixed(2)}</strong></span>
        </div>
      </div>
      <div class="metrics">
        <div class="metric"><span class="metric-label">最佳概率</span><span class="metric-value mono">${bestProb === null ? "—" : Math.round(bestProb * 100) + "%"}</span></div>
        <div class="metric"><span class="metric-label">样本数</span><span class="metric-value mono">${st.n}</span></div>
        <div class="metric"><span class="metric-label">均值</span><span class="metric-value mono">${Math.round(st.mean)}</span></div>
        <div class="metric"><span class="metric-label">中位数</span><span class="metric-value mono">${st.median}</span></div>
      </div>
    </div>
    <div class="sep"></div>
  `;

      const list = rows.map(x => {
        const pct = (x.p === null) ? 0 : Math.round(x.p * 100);
        const barPct = clamp(pct, 0, 100);
        const probText = (x.p === null) ? "—" : `${pct}%`;
        const probClass = (x.p === null) ? "" : (x.p >= 0.75 ? "good" : (x.p >= 0.4 ? "warn" : "bad"));
        const cat = probCategory(x.p);
        const gap = (st.n === 0) ? "—" : Math.round((st.mean ?? 0) - x.thr);
        return `
      <div class="school">
        <div class="school-head">
          <div>
            <div class="school-title">${escapeHtml(x.s.name)}</div>
            <div class="school-sub">评估门槛：<span class="mono">${x.thr}</span></div>
          </div>
          <div class="school-status">
            <span class="school-tag ${cat.cls}">${cat.label}</span>
            <span class="status-pill ${probClass}">达成 <strong>${probText}</strong></span>
          </div>
        </div>
        <div class="metrics">
          <div class="metric"><span class="metric-label">均值</span><span class="metric-value mono">${st.n === 0 ? "—" : Math.round(st.mean)}</span></div>
          <div class="metric"><span class="metric-label">门槛</span><span class="metric-value mono">${x.thr}</span></div>
          <div class="metric"><span class="metric-label">均值差</span><span class="metric-value mono">${gap}</span></div>
        </div>
        <div class="school-progress">
          <div class="bar"><div style="width:${barPct}%;"></div></div>
            <div class="school-note">模考概率基于学生历史成绩分布估算。</div>
        </div>
      </div>
    `;
      }).join("");

      wrap.innerHTML = header + list;
    }

    /* =========================
       Navigation
       ========================= */
    function setPage(page) {
      appState.page = page;
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("on", t.getAttribute("data-page") === page);
      });
      ["targets", "filter", "mocks", "eval"].forEach(p => {
        document.getElementById("page-" + p).style.display = (p === page) ? "" : "none";
      });

      $("subtitle").textContent =
        page === "targets" ? "目标：跟踪清单与标记"
          : page === "filter" ? "筛选：推荐学校池（加入目标）"
            : page === "mocks" ? "模考：科目结构与多次录入"
              : "评估：目标达成可能性";

      if (page === "targets") renderTargetsPage();
      if (page === "filter") renderFilter();
      if (page === "mocks") renderMocksPage();
      if (page === "eval") renderEvalPage();

      saveState();
    }

    /* =========================
       Bind
       ========================= */
    function bind() {
      $("sheetClose").addEventListener("click", closeSheet);
      $("backdrop").addEventListener("click", (e) => { if (e.target === $("backdrop")) closeSheet(); });
      window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeSheet(); });

      document.querySelectorAll(".tab").forEach(t => {
        t.addEventListener("click", () => setPage(t.getAttribute("data-page")));
      });

      $("btnHelp").addEventListener("click", () => {
        openSheet("使用方式", "目标学校跟踪 + 模考评估", `
      <ol>
        <li>先在「目标」页明确：你要追踪哪些学校（冲/稳/保）。</li>
        <li>去「筛选」页调整区/初中等条件，把学校加入目标。</li>
        <li>去「模考」页录入多次模考。</li>
        <li>在「评估」页查看每个目标的达成概率（演示）。</li>
      </ol>
      <div class="sep"></div>
      <p class="hint"><b>说明：</b>本Demo的名额与分数线为示例；概率模型为演示。真实产品建议按位次/排名建模并做批次规则模拟。</p>
    `);
      });

      $("btnExplainZKMode").addEventListener("click", () => {
        openSheet("上海中考模式（大致逻辑）", "用于产品引导文案（概览）", `
      <p class="hint">
        <b>核心思路：</b>把“复杂规则”拆成「批次顺序 + 志愿数量 + 资格条件」三件事。
      </p>
      <div class="sep"></div>
      <div class="hint"><b>一、三大录取批次（按顺序）</b></div>
      <ul>
        <li><b>自主招生：</b>市实验/市特色等自招；体艺骨干等（需资格）；国际课程/合作办学通常另有流程；中职校自主招生（中本贯通/五年一贯制/中高职贯通/提前招生等）。</li>
        <li><b>名额分配综合评价：</b>包含<b>到区</b>与<b>到校</b>（到校通常对“本校在籍在读满3年的应届生”等有资格限制）。</li>
        <li><b>统一招生：</b>面向完成中招报名的学生，通常设置多志愿（示例：1-15志愿）+ 征求志愿。</li>
      </ul>
      <div class="sep"></div>
      <div class="hint"><b>二、志愿填报节奏（常见）</b></div>
      <ul>
        <li>一般在学业考试后、成绩发布前：线上填报 + 线下确认。</li>
        <li>若在前一批次已被录取，后一批次志愿将自然失效。</li>
      </ul>
      <div class="sep"></div>
      <p class="hint">
        <b>产品落地建议：</b>把每个目标学校拆成“可参与的批次/志愿栏位/资格限制/历史分数线/名额数量”，让家长一眼看懂“我能报什么、怎么报、概率如何”。
      </p>
    `);
      });

      $("btnExplainProfile").addEventListener("click", () => {
        openSheet("为什么要选当前初中？", "到校名额依赖初中维度", `
      <ul>
        <li>“到校”名额按<b>初中</b>分配到高中。</li>
        <li>同区同分，不同初中可冲的目标不同。</li>
      </ul>
    `);
      });

      $("btnExplainScore").addEventListener("click", () => {
        openSheet("概率与门槛说明", "演示模型口径", `
      <ul>
        <li>用模考总分样本估计均值/波动。</li>
        <li>评估门槛 = 统一最低分（示例） + 波动修正。</li>
        <li>估算 P(总分 ≥ 评估门槛)。</li>
      </ul>
    `);
      });

      $("btnExplainEval").addEventListener("click", () => {
        openSheet("评估页说明", "怎么用它？", `
      <ul>
        <li>单校：看“达成概率”随模考变化。</li>
        <li>整体：给“至少一所目标达成”的合成概率（仅演示）。</li>
      </ul>
    `);
      });

      $("btnExport").addEventListener("click", () => {
        const text = JSON.stringify(appState, null, 2);
        navigator.clipboard?.writeText(text).then(() => {
          toast("已复制当前数据 JSON（含目标与模考）");
        }).catch(() => {
          openSheet("导出数据（JSON）", "浏览器不允许自动复制，手动复制即可。", `<textarea class="mono" style="width:100%;height:280px">${text}</textarea>`);
        });
      });

      // filter inputs
      $("district").addEventListener("change", () => {
        appState.profile.district = $("district").value;
        renderMiddleSchools();
        saveState();
        renderAll();
      });
      $("juniorType").addEventListener("change", () => {
        appState.profile.juniorType = $("juniorType").value;
        saveState(); renderAll();
      });
      $("middleSchool").addEventListener("change", () => {
        appState.profile.middleSchoolId = $("middleSchool").value;
        saveState(); renderAll();
      });
      ["scoreStable", "scoreHigh", "scoreLow"].forEach(id => {
        $(id).addEventListener("input", () => {
          appState.profile.stable = Number($("scoreStable").value || 0);
          appState.profile.high = Number($("scoreHigh").value || 0);
          appState.profile.low = Number($("scoreLow").value || 0);
          saveState(); renderAll();
        });
      });

      $("schoolType").addEventListener("change", () => { saveState(); renderAll(); });

      // targets clear
      $("btnClearTargets").addEventListener("click", () => {
        if (appState.targets.length === 0) { toast("目标清单为空"); return; }
        openSheet("清空目标学校？", "将移除全部目标（本地存储）", `
      <p class="hint">当前目标数：<b>${appState.targets.length}</b></p>
      <div class="btnrow" style="margin-top:10px">
        <button class="btn" id="btnCancel">取消</button>
        <button class="btn danger" id="btnOK">确认清空</button>
      </div>
    `);
        setTimeout(() => {
          $("btnCancel").onclick = closeSheet;
          $("btnOK").onclick = () => {
            appState.targets = [];
            saveState();
            closeSheet();
            toast("已清空");
            renderAll();
          };
        }, 0);
      });

      // mocks
      $("btnAddMockFloating").addEventListener("click", () => {
        $("mockModalName").value = "";
        const subjectsContainer = $("mockModalSubjects");
        subjectsContainer.innerHTML = appState.subjects.map(s => `
      <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:rgba(17,24,39,.03);border-radius:12px;">
        <span style="font-size:13px;font-weight:600;min-width:60px;">${s.key}</span>
        <input type="number" id="mockScore_${s.key}" min="0" max="${s.max}" placeholder="0" style="flex:1;text-align:right;padding:10px 14px;font-size:15px;border-radius:10px;" />
        <span style="font-size:12px;color:var(--muted);min-width:30px;">/ ${s.max}</span>
      </div>
    `).join("");
        $("mockModal").style.display = "flex";
        $("mockModal").setAttribute("aria-hidden", "false");
        $("mockModalName").focus();
      });

      // 模考弹框事件
      $("mockModalClose").addEventListener("click", closeMockModal);
      $("mockModalCancel").addEventListener("click", closeMockModal);
      $("mockModalSave").addEventListener("click", saveMock);
      $("mockModal").addEventListener("click", (e) => { if (e.target === $("mockModal")) closeMockModal(); });
    }

    /* =========================
       Render all
       ========================= */
    function renderAll() {
      // filter页面依赖select渲染
      if ($("district")) renderDistrictSelect();
      if (appState.page === "targets") renderTargetsPage();
      if (appState.page === "filter") renderFilter();
      if (appState.page === "mocks") renderMocksPage();
      if (appState.page === "eval") renderEvalPage();
    }

    /* =========================
       Init
       ========================= */
    (function init() {
      // filter controls init (即使不在筛选页也先初始化，避免切换时报错)
      renderDistrictSelect();
      $("district").value = appState.profile.district;
      renderMiddleSchools();

      bind();
      setPage(appState.page || "targets");
      renderAll();
    })();
  </script>
</body>

</html>