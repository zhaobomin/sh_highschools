# 学校详情模块需求变更文档

## 1. 变更概述

### 1.1 变更背景

学校详情模块需要进行需求迭代，以提供更全面的学校信息展示，包括基本信息、招生情况和学校介绍，并解决iOS端页面头部遮挡的问题。

### 1.2 变更目标

- 丰富学校详情页面的信息展示内容
- 提供最近一年的招生情况数据
- 添加学校介绍板块
- 修复iOS端页面显示问题

### 1.3 变更范围

- 前端：学校详情页面（SchoolDetailPage.tsx）及其相关组件
- 后端：学校详情API接口
- 数据：学校基本信息、招生数据、学校介绍内容

## 2. 需求详情

### 2.1 功能需求

| 需求ID | 需求描述                                                                 | 优先级 | 验收标准                               |
| ------ | ------------------------------------------------------------------------ | ------ | -------------------------------------- |
| FR-001 | 显示学校基本信息，包括学校名称、所属区、学校类型、备注、住宿情况等信息   | 高     | 页面正确显示学校基本信息，数据来源准确 |
| FR-002 | 显示学校最近一年的招生情况：包括自招、到区、到校的总人数                 | 高     | 页面正确显示招生数据，数据来源准确     |
| FR-003 | 显示学校介绍（介绍内容，可以先直接在页面上默认填充一下，现在还没有数据） | 中     | 页面显示学校介绍板块，默认填充内容合理 |
| FR-004 | 解决bug，现在这个页面在ios上显示，页面头部会被遮挡                       | 高     | iOS端页面头部显示正常，无遮挡问题      |

### 2.2 非功能需求

| 需求ID  | 需求描述                                    | 优先级 | 验收标准                                   |
| ------- | ------------------------------------------- | ------ | ------------------------------------------ |
| NFR-001 | 页面加载性能：学校详情页面加载时间不超过2秒 | 中     | 在网络条件良好的情况下，页面加载时间≤2秒   |
| NFR-002 | 响应式设计：页面在不同设备上显示正常        | 中     | 页面在手机、平板等设备上显示正常，布局合理 |
| NFR-003 | 可访问性：页面符合基本的可访问性标准        | 低     | 页面支持屏幕阅读器，键盘导航正常           |

## 3. 数据需求

### 3.1 数据结构

| 数据字段         | 数据类型 | 描述                                   | 来源                                              |
| ---------------- | -------- | -------------------------------------- | ------------------------------------------------- |
| 学校名称         | 字符串   | 学校的正式名称                         | 高中学校表（schools.name）                        |
| 所属区           | 字符串   | 学校所在的区县                         | 高中学校表（schools.district）                    |
| 学校类型         | 字符串   | 学校的类型（市重点、区重点、一般高中） | 高中学校表（schools.type）                        |
| 完整类型         | 字符串   | 学校的完整类型描述                     | 高中学校表（schools.full_type）                   |
| 住宿情况         | 字符串   | 学校的住宿条件                         | 高中学校表（schools.accommodation）               |
| 备注             | 文本     | 学校的备注信息                         | 高中学校表（schools.note）                        |
| 自招人数         | 整数     | 学校最近一年的自主招生人数             | 自主招生名额表（self_enrollment_quota）           |
| 到区人数         | 整数     | 学校最近一年的到区招生人数             | 到区名额及录取分数线表（district_seats）          |
| 到校人数         | 整数     | 学校最近一年的到校招生人数             | 到校名额及录取分数线表（school_seats）            |
| 到区分数线区间   | 数组     | 学校最近一年的到区分数线最低和最高值   | 到区名额及录取分数线表（district_seats）          |
| 到校分数线区间   | 数组     | 学校最近一年的到校分数线最低和最高值   | 到校名额及录取分数线表（school_seats）            |
| 平行志愿分数线   | 数字     | 学校最近一年的平行志愿分数线           | 平行志愿录取分数线表（parallel_admission_scores） |
| 学校介绍         | 文本     | 学校的详细介绍内容                     | 默认填充内容                                      |

### 3.2 数据来源

- 学校基本信息：高中学校表（schools）
- 招生情况数据：
  - 自招：自主招生名额表（self_enrollment_quota）
  - 到区：到区名额及录取分数线表（district_seats）
  - 到校：到校名额及录取分数线表（school_seats）
  - 平行志愿：平行志愿录取分数线表（parallel_admission_scores）
- 学校介绍：使用默认填充内容，暂不存储在数据库中

### 3.3 接口设计

**接口路径**：`/schools/{school_id}/detail`
**方法**：GET
**功能**：获取学校详情的所有数据，包括基本信息、招生情况、录取分数线等

**请求参数**：
| 参数名    | 类型   | 必填 | 描述                 |
| --------- | ------ | ---- | -------------------- |
| school_id | string | 是   | 学校ID               |
| year      | number | 否   | 年份，默认为最近一年 |

**响应数据**：
```json
{
  "data": {
    "id": "1",
    "name": "上海市第一中学",
    "code": "10001",
    "district": "黄浦",
    "type": "市重点",
    "fullType": "上海市实验性示范性高中",
    "note": "学校创建于1901年，是上海市历史悠久的名校之一",
    "introduction": "上海市第一中学是一所位于上海市的高中学校，致力于为学生提供优质的教育资源和学习环境...",
    "enrollment": {
      "autonomous": 0,  // 自主招生数据，后续将从self_enrollment_quota表中查询
      "toDistrict": 100,
      "toSchool": 150,
      "year": 2025
    },
    "scores": {
      "toDistrict": [700.0, 710.5],  // 到区分数线区间（最低值，最高值）
      "toSchool": [695.0, 705.0],    // 到校分数线区间（最低值，最高值）
      "unified": 695.5,
      "parallel": 690.0
    },
    "probability": 75
  }
}
```

**后端实现**：
- **数据库查询优化**：使用子查询和聚合函数一次性获取所有相关数据，减少数据库查询次数
- **性能优化**：
  - 减少数据库查询次数：从多次查询减少到2次查询
  - 使用COALESCE函数处理NULL值，确保数据一致性
  - 利用现有索引提高查询速度
  - 批量查询避免多次数据库往返
- **缓存策略**：对热点学校数据进行缓存，进一步优化响应时间

## 4. 范围限定

- 本次变更仅涉及学校详情模块的前端展示和后端API调整
- 学校介绍内容暂时使用默认填充，后续将通过后台管理系统进行维护
- 招生情况数据仅显示最近一年的数据

## 5. 页面结构与组件设计

### 5.1 页面结构

| 模块名称     | 功能描述                                               | 组件名称                  | 位置           | 容器组件           |
| ------------ | ------------------------------------------------------ | ------------------------- | -------------- | ------------------ |
| 页面头部     | 显示学校名称和返回按钮                                 | SchoolHeaderSection       | 页面顶部       | ProfileSectionCard |
| 学校基本信息 | 显示学校名称、所属区、学校类型、备注、住宿情况等       | SchoolHeaderSection       | 页面头部下方   | ProfileSectionCard |
| 招生情况     | 显示学校最近一年的招生情况（自招、到区、到校的总人数） | SchoolEnrollmentSection   | 基本信息下方   | SectionCard        |
| 学校介绍     | 显示学校介绍（默认填充内容）                           | SchoolIntroductionSection | 招生情况下方   | SectionCard        |
| 录取分数线   | 显示学校的录取分数线信息                               | SchoolScoresSection       | 学校介绍下方   | SectionCard        |
| 录取概率     | 显示学生被学校录取的概率                               | SchoolProbabilitySection  | 录取分数线下方 | SectionCard        |
| 招生指南     | 显示招生相关的指南信息                                 | AdmissionGuideSection     | 页面底部       | SectionCard        |

### 5.2 组件设计

#### 5.2.1 整体布局设计

**参考TAB页设计**：
- 页面使用与TAB页一致的布局结构
- 组件之间的留白与TAB页保持一致
- 使用相同的卡片样式和阴影效果
- 保持一致的字体大小和颜色方案

**页面留白规范**：
- 页面顶部：24px
- 组件之间：16px
- 组件内部：12px
- 页面底部：24px

#### 5.2.2 SchoolHeaderSection

**功能**：显示学校头部信息，包括学校名称、返回按钮和基本信息

**组件结构**：
- 头部标题栏：包含学校名称和返回按钮
- 基本信息网格：显示学校代码、所属区、学校类型、住宿情况、备注等信息

**样式设计**：
- 使用ProfileSectionCard组件，保持与TAB页一致的卡片样式
- 头部标题栏使用蓝色背景，白色文字
- 基本信息使用网格布局，清晰易读
- 与TAB页保持一致的间距和边距

#### 5.2.3 SchoolEnrollmentSection

**功能**：显示学校最近一年的招生情况

**组件结构**：
- 标题：最近一年招生情况
- 数据网格：显示自招、到区、到校的总人数
- 数据来源标注：注明数据来源年份

**样式设计**：
- 使用SectionCard组件，保持与TAB页一致的卡片样式
- 数据网格使用三列布局，每列显示一个招生类型
- 使用大号字体显示招生人数，突出重要信息
- 与TAB页保持一致的间距和边距

#### 5.2.4 SchoolIntroductionSection

**功能**：显示学校介绍内容

**组件结构**：
- 标题：学校介绍
- 内容区域：显示学校介绍文本
- 默认内容：当没有数据时显示默认填充内容

**样式设计**：
- 使用SectionCard组件，保持与TAB页一致的卡片样式
- 内容区域使用适当的行高和字体大小，确保可读性
- 默认内容使用灰色文字，与实际内容区分
- 与TAB页保持一致的间距和边距

#### 5.2.5 SchoolScoresSection

**功能**：显示学校的录取分数线信息

**组件结构**：
- 标题：录取分数线
- 分数线列表：显示不同招生类型的分数线

**样式设计**：
- 使用SectionCard组件，保持与TAB页一致的卡片样式
- 分数线信息使用表格形式展示，清晰易读
- 与TAB页保持一致的间距和边距

#### 5.2.6 SchoolProbabilitySection

**功能**：显示学生被学校录取的概率

**组件结构**：
- 标题：录取概率
- 概率指示器：使用进度条显示概率
- 概率等级：显示高、中、低等级

**样式设计**：
- 使用SectionCard组件，保持与TAB页一致的卡片样式
- 进度条根据概率值显示不同颜色（高：绿色，中：黄色，低：红色）
- 与TAB页保持一致的间距和边距

#### 5.2.7 AdmissionGuideSection

**功能**：显示招生相关的指南信息

**组件结构**：
- 标题：招生指南
- 指南内容：显示招生相关的指导信息

**样式设计**：
- 使用SectionCard组件，保持与TAB页一致的卡片样式
- 内容使用列表形式展示，便于阅读
- 与TAB页保持一致的间距和边距

#### 5.2.8 SectionCard组件使用规范

**组件属性**：
- `title`：卡片标题
- `description`：卡片描述（可选）
- `children`：卡片内容
- `divider`：是否显示标题和内容之间的分隔线
- `gap`：内容内部的间距（xs、sm、md、lg）
- `variant`：卡片变体（default、plain）

**使用示例**：
```tsx
<SectionCard title="最近一年招生情况" gap="md">
  {/* 招生情况内容 */}
</SectionCard>
```

**与TAB页保持一致的设置**：
- 使用默认的gap设置（md）
- 保持卡片之间的间距为16px
- 使用一致的字体大小和颜色方案
- 遵循相同的布局结构和对齐方式

### 5.3 响应式设计

**设计原则**：
- 移动优先：优先考虑移动设备的显示效果
- 弹性布局：使用弹性布局适应不同屏幕尺寸
- 断点设计：根据不同屏幕尺寸调整布局

**断点设置**：
- 小屏幕（< 640px）：单列布局，组件垂直排列
- 中等屏幕（640px - 1024px）：双列布局，部分组件并排显示
- 大屏幕（> 1024px）：多列布局，充分利用屏幕空间

### 5.4 交互设计

**导航设计**：
- 顶部返回按钮：点击返回上一页
- 平滑滚动：组件间滚动流畅

**加载状态**：
- 骨架屏：数据加载时显示骨架屏
- 错误状态：数据加载失败时显示错误信息和重试按钮

**动画效果**：
- 组件入场动画：页面加载时组件淡入
- 数据更新动画：数据更新时使用平滑过渡

### 5.5 技术实现

**前端技术**：
- React 18：组件化开发
- TypeScript：类型安全
- Tailwind CSS：样式管理
- React Query：数据获取和缓存

**移动端适配**：
- Capacitor：跨平台移动应用
- 安全区域：使用react-native-safe-area-context处理iOS刘海屏

**性能优化**：
- 代码分割：使用React.lazy和Suspense
- 数据缓存：使用React Query的缓存机制
- 图片优化：使用适当尺寸的图片

## 6. 风险/依赖备注

| 类型   | 关联编号/功能点 | 具体内容/说明                                     | 备注                             |
| ------ | --------------- | ------------------------------------------------- | -------------------------------- |
| 风险点 | FR-003          | 学校介绍数据缺失，需要默认填充内容                | 建议准备通用的默认介绍模板       |
| 风险点 | FR-004          | iOS端页面头部遮挡问题可能与设备型号和系统版本有关 | 需要在多个iOS设备上进行测试验证  |
| 依赖项 | FR-002          | 招生情况数据依赖于招生数据表的完整性              | 确保招生数据表中有最近一年的数据 |
| 依赖项 | FR-004          | iOS端适配依赖于react-native-safe-area-context库   | 确保正确安装和配置该库           |



## 6. 验收标准

### 6.1 功能验收

1. **FR-001**：学校基本信息展示
   - 页面显示学校名称、所属区、学校类型、备注、住宿情况等信息
   - 数据显示正确，与数据库中的数据一致

2. **FR-002**：招生情况展示
   - 页面显示学校最近一年的自招、到区、到校的总人数
   - 数据显示正确，与数据库中的数据一致

3. **FR-003**：学校介绍展示
   - 页面显示学校介绍板块
   - 当没有数据时，显示默认填充的内容

4. **FR-004**：iOS端页面显示问题修复
   - iOS端页面头部显示正常，无遮挡问题
   - 在不同iOS设备上测试通过

### 6.2 非功能验收

1. **NFR-001**：页面加载性能
   - 页面加载时间不超过2秒

2. **NFR-002**：响应式设计
   - 页面在手机、平板等设备上显示正常
   - 布局合理，无元素重叠或溢出

3. **NFR-003**：可访问性
   - 页面支持屏幕阅读器
   - 键盘导航正常

## 7. 项目计划

### 7.1 开发计划

| 任务         | 负责人   | 预计工时 | 开始日期   | 结束日期   |
| ------------ | -------- | -------- | ---------- | ---------- |
| 前端页面修改 | 前端开发 | 4小时    | 2026-02-03 | 2026-02-03 |
| 后端API调整  | 后端开发 | 2小时    | 2026-02-03 | 2026-02-03 |
| 数据结构调整 | 后端开发 | 1小时    | 2026-02-03 | 2026-02-03 |
| 测试验证     | 测试人员 | 2小时    | 2026-02-04 | 2026-02-04 |

### 7.2 里程碑

| 里程碑   | 日期       | 描述                     |
| -------- | ---------- | ------------------------ |
| 需求确认 | 2026-02-02 | 完成需求文档评审         |
| 开发完成 | 2026-02-03 | 完成前端和后端开发       |
| 测试完成 | 2026-02-04 | 完成功能测试和兼容性测试 |
| 上线部署 | 2026-02-05 | 完成代码部署和线上验证   |

## 8. 附录

### 8.1 参考资料

- 高中学校表字段结构
- 招生数据相关表结构
- iOS端页面显示问题截图

### 8.2 术语定义

| 术语     | 解释                                           |
| -------- | ---------------------------------------------- |
| 自招     | 自主招生，学校自主选拔学生的招生方式           |
| 到区     | 分配到区，高中学校分配给特定区县的招生名额     |
| 到校     | 分配到校，高中学校分配给特定初中学校的招生名额 |
| 市重点   | 上海市重点高中学校                             |
| 区重点   | 上海区县重点高中学校                           |
| 一般高中 | 上海市普通高中学校                             |