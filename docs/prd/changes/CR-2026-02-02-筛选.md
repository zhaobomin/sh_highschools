# 筛选模块需求变更文档

## 基本信息
- **变更编号**：CR-2026-02-02-筛选
- **变更模块**：筛选模块
- **变更日期**：2026-02-02
- **变更类型**：功能迭代

## 变更内容

### 1. 概率计算逻辑更新

#### 变更前
- 基于学生的稳定分、上限分、下限分与基准分的比较
- 逻辑：
  - 如果下限分 >= 基准分：返回 85
  - 如果稳定分 >= 基准分：返回 65
  - 如果上限分 >= 基准分：返回 40
  - 否则：返回 15

#### 变更后
- 以高中学校最近一年的平行志愿录取分数线为基准
- 逻辑：
  - 下限分 > 平行志愿录取分数线 => "拿捏"
  - 下限分 < 平行志愿录取分数线 and 上限分 > 平行志愿录取分数线 => "可冲"
  - 上限分 < 平行志愿录取分数线 => "难"

### 2. 前端标签颜色更新

#### 变更前
- 等级分为：high、mid、low
- 对应的标签为：保、稳、冲
- 对应的颜色为：绿色、黄色、红色

#### 变更后
- 标签为：拿捏、可冲、难
- 对应的颜色为：绿色、黄色、红色

### 3. 目标页同步更新

#### 变更前
- 目标页使用与筛选页相同的标签体系：保、稳、冲
- 对应的颜色为：绿色、黄色、红色

#### 变更后
- 目标页同步使用新的标签体系：拿捏、可冲、难
- 对应的颜色保持不变：难（红色），拿捏（绿色）、可冲（黄色）

## 技术设计方案

### 1. 后端修改

#### 文件：`app/services/utils.py`
- 修改 `probability_from_profile` 函数，更新概率计算逻辑
- 调整返回值以匹配新的标签体系

#### 文件：`app/services/schools_service.py`
- 确保使用正确的平行志愿录取分数线作为基准分
- 调整相关的概率计算逻辑

#### 后端计算逻辑伪代码
```python
def probability_from_profile(benchmark, stable_score, high_score, low_score):
    if stable_score is None or high_score is None or low_score is None:
        return None
    if high_score < low_score:
        return None
    # 使用平行志愿录取分数线作为基准分
    if low_score > benchmark:
        return 85  # 拿捏
    if low_score < benchmark and high_score > benchmark:
        return 50  # 可冲
    if high_score < benchmark:
        return 15  # 难
    return None
```

#### 后端基准分获取伪代码
```python
def get_benchmark_score(school_id):
    # 从数据库获取学校最近一年的平行志愿录取分数线
    # 假设数据表为 parallel_admission_scores，字段为 school_code, score, year
    latest_year = get_latest_year()
    score = db.select(
        "parallel_admission_scores", 
        ["score"], 
        {"school_code": school_id, "year": latest_year}
    )
    return score[0]["score"] if score else None
```

### 2. 前端修改

#### 文件：`src/lib/evaluation.ts`
- 修改 `levelFromProbability` 函数，更新等级计算逻辑
- 调整返回值以匹配新的标签体系

#### 前端计算逻辑伪代码
```typescript
export function levelFromProbability(p: number): ProbabilityLevel {
  if (p >= 75) return 'high';  // 拿捏
  if (p >= 35) return 'mid';   // 可冲
  return 'low';                // 难
}
```

#### 文件：`src/features/filter/components/RecommendationSection.tsx`
- 更新标签显示逻辑，使用新的标签：拿捏、可冲、难
- 保持颜色不变：难（红色），拿捏（绿色）、可冲（黄色）

#### 文件：`src/features/targets/components/TargetsListSection.tsx`
- 更新标签显示逻辑，使用新的标签：拿捏、可冲、难
- 保持颜色不变：难（红色），拿捏（绿色）、可冲（黄色）

#### 前端标签显示伪代码
```typescript
// 标签显示逻辑（适用于筛选页和目标页）
const level = levelFromProbability(probability / 100);
const levelMap = {
  high: { label: '拿捏', color: 'bg-green-100 text-green-700' },
  mid: { label: '可冲', color: 'bg-amber-100 text-amber-700' },
  low: { label: '难', color: 'bg-rose-100 text-rose-700' }
};
const { label, color } = levelMap[level];

// 标签渲染
<div className={`px-2 py-0.5 rounded-full text-xs font-medium whitespace-nowrap flex-shrink-0 ${color}`}>
  {label}
</div>
```

### 3. API 接口

#### 现有接口
- `GET /api/v1/schools/list` - 获取学校列表，包含概率信息

#### 变更
- 接口参数不变
- 响应数据中的概率计算逻辑更新
- 确保响应数据包含正确的平行志愿录取分数线

#### 后端API计算逻辑伪代码
```python
# API接口实现伪代码 (app/api/v1/schools.py)
@app.get("/api/v1/schools/list")
def list_schools(
    q: str = "",
    district: str = None,
    type_: str = None,
    middleSchoolId: str = None,
    stableScore: float = None,
    highScore: float = None,
    lowScore: float = None,
    page: int = 1,
    perPage: int = 10
):
    # 解析参数
    params = parse_list_schools_params(locals())
    
    # 获取学校列表
    schools, total = fetch_enriched_schools(
        db=db,
        q=params["q"],
        district=params["district"],
        type_=params["type_"],
        middle_school_id=params["middle_school_id"],
        stable_score=params["stable_score"],
        high_score=params["high_score"],
        low_score=params["low_score"],
        page=params["page"],
        per_page=params["per_page"]
    )
    
    # 处理每个学校的概率计算
    for school in schools:
        # 获取学校的平行志愿录取分数线作为基准分
        benchmark_score = get_benchmark_score(school["id"])
        
        # 计算概率
        if benchmark_score and params["stable_score"] and params["high_score"] and params["low_score"]:
            probability = probability_from_profile(
                benchmark=benchmark_score,
                stable_score=params["stable_score"],
                high_score=params["high_score"],
                low_score=params["low_score"]
            )
            # 更新学校的概率信息
            if "stats" not in school:
                school["stats"] = {}
            school["stats"]["probability"] = probability
            school["stats"]["scoreUnified"] = benchmark_score
    
    # 返回响应
    return {
        "data": schools,
        "total": total,
        "page": params["page"],
        "perPage": params["per_page"]
    }
```

## 实现注意事项

1. **数据准确性**：确保使用正确的平行志愿录取分数线作为基准分
2. **向后兼容**：确保变更不会影响现有的功能和数据
3. **性能优化**：确保概率计算逻辑的性能良好，不会影响页面加载速度
4. **用户体验**：确保标签显示清晰，颜色搭配合理，符合用户预期

## 测试计划

1. **单元测试**：测试概率计算逻辑的正确性
2. **集成测试**：测试前后端交互的正确性
3. **用户测试**：测试用户体验和界面显示的正确性

## 变更影响范围

- **前端**：
  - 筛选页面的推荐学校列表显示
  - 目标页面的目标学校列表显示
- **后端**：学校概率计算逻辑
- **数据**：使用平行志愿录取分数线作为基准分

## 预期效果

1. **逻辑清晰**：概率计算逻辑更加简单明了，易于理解
2. **结果准确**：基于平行志愿录取分数线的计算结果更加准确
3. **体验良好**：标签显示清晰，颜色搭配合理，符合用户预期

## 实施计划

1. **后端实现**：更新概率计算逻辑
2. **前端实现**：更新标签显示逻辑
3. **测试验证**：确保功能正确性和用户体验
4. **部署上线**：发布变更到生产环境