# 学校详情模块需求变更文档

## 变更基本信息
- **变更类型**: 需求迭代
- **模块名称**: 学校详情
- **变更日期**: 2026-02-03
- **变更编号**: CR-2026-02-03-学校详情

## 变更背景
学校详情模块需要进行功能迭代，优化数据获取方式和前端展示结构，提升用户体验。

## 变更内容

### 1. API修改
- **现状**: 学校详情API从多个表获取数据，自招相关信息不完整
- **变更**: 从自招表（self_enrollment_quota）获取完整的自招信息
- **详细要求**: 
  - 自招：总人数（total_quota）、艺术生（art_quota）、体育生（sports_quota）
  - 到区：总人数（to_district_total）
  - 到校：总人数（to_school_total）
  - 住宿：住宿情况（boarding_status）

### 2. 前端页面结构调整

#### 2.1 卡片顺序调整
- **现状**: 学校介绍卡片位于页面中间位置
- **变更**: "学校介绍"卡片放到页面的第一位

#### 2.2 近一年招聘情况卡片
- **现状**: 显示基本招聘数据
- **变更**: 
  - 增加自招体育生人数和艺术生人数
  - 样式做重新布局

#### 2.3 录取分数线卡片
- **现状**: 可能存在重复数据，样式与其他卡片不一致
- **变更**: 
  - 剔出重复数据
  - 样式和"近一年招聘情况"保持一致

#### 2.4 新增学生画像卡片
- **现状**: 无学生画像卡片
- **变更**: 
  - 增加基于学生画像卡片
  - 不需要操作按钮，其他保持一致
  - 内容直接跟目标页一致，内容可以前端带过来

#### 2.5 删除卡片
- **现状**: 存在以下卡片：
  - 学校基础数据卡片（包含：学校全程、学校代码、住宿等）
  - 上海中考志愿与录取方式卡片
  - 录取概率分析卡片
- **变更**: 删除上述三张卡片

## 技术设计方案

### 1. API设计
- **接口路径**: `/api/schools/<school_id>/detail`
- **请求方法**: GET
- **请求参数**: 
  - `school_id`: 学校代码（必填）
  - `year`: 年份（可选）
- **响应数据结构**:
  ```json
  {
    "data": {
      "id": "string",
      "name": "string",
      "code": "string",
      "district": "string",
      "type": "string",
      "fullType": "string",
      "note": "string",
      "introduction": "string",
      "enrollment": {
        "totalQuota": number,
        "sportsQuota": number,
        "artQuota": number,
        "toDistrictTotal": number,
        "toSchoolTotal": number,
        "boardingStatus": "string",
        "year": number
      },
      "scores": {
        "toDistrict": [number, number],
        "toSchool": [number, number],
        "unified": number
      },
      "studentProfile": {
        "district": "string",
        "middleSchool": "string",
        "scores": {
          "stable": number,
          "high": number,
          "low": number
        }
      }
    },
    "message": "success"
  }
  ```

### 2. 前端组件修改

#### 2.1 页面结构调整
- **文件**: `src/features/schools/SchoolDetailPage.tsx`
- **修改内容**: 
  - 调整卡片渲染顺序，将SchoolIntroductionSection放到第一位
  - 删除不需要的卡片组件：
    - SchoolHeaderSection（基础数据卡片）
    - AdmissionGuideSection（中考志愿与录取方式）
    - SchoolProbabilitySection（录取概率分析）
  - 新增学生画像卡片组件

#### 2.2 近一年招聘情况组件
- **文件**: `src/features/schools/components/SchoolEnrollmentSection.tsx`
- **修改内容**: 
  - 增加体育生和艺术生人数显示
  - 重新布局样式，与录取分数线卡片保持一致

#### 2.3 录取分数线组件
- **文件**: `src/features/schools/components/SchoolScoresSection.tsx`
- **修改内容**: 
  - 增加数据去重逻辑
  - 调整样式，与招聘情况卡片保持一致

#### 2.4 新增学生画像卡片组件
- **文件**: `src/features/schools/components/SchoolProfileSection.tsx`
- **功能**: 显示学生画像信息，从前端传入数据

### 3. 后端逻辑修改

#### 3.1 学校详情API
- **文件**: `app/services/schools_service.py`
- **修改函数**: `get_school_detail_all`
- **修改内容**: 
  - 从self_enrollment_quota表获取完整的自招数据
  - 包含：总名额、体育生、艺术生、到区总人数、到校总人数、住宿情况
  - 优化数据查询逻辑，减少数据库查询次数
- **伪代码实现**:
  ```python
  def get_school_detail_all(db, school_id, year=None):
      # 获取最近一年
      if not year:
          year_candidates = [
              _latest_year_from("district_seats", "high_school_code"),
              _latest_year_from("school_seats", "high_school_code"),
              _latest_year_from("parallel_admission_scores", "high_school_code"),
              _latest_year_from("self_enrollment_quota", "school_code"),
          ]
          year_candidates = [value for value in year_candidates if value is not None]
          year = max(year_candidates) if year_candidates else None
      
      # 查询学校基本信息
      try:
          school = db.select(
              "schools",
              ["code", "name", "district", "type", "full_type", "note"],
              {"code": school_id}
          )[0]
      except Exception:
          # 处理异常情况
          school = {"code": school_id, "name": f"学校{school_id}", ...}
      
      # 从自招表获取完整数据
      try:
          autonomous_conditions = {"school_code": school_id}
          if year is not None:
              autonomous_conditions["year"] = year
          
          # 从self_enrollment_quota表获取数据
          autonomous_records = db.select(
              "self_enrollment_quota",
              ["total_quota", "sports_quota", "art_quota", "to_district_total", "to_school_total", "boarding_status"],
              autonomous_conditions,
              limit=1
          )
          
          # 处理自招数据
          if autonomous_records:
              autonomous_data = autonomous_records[0]
              total_quota = autonomous_data.get("total_quota", 0)
              sports_quota = autonomous_data.get("sports_quota", 0)
              art_quota = autonomous_data.get("art_quota", 0)
              to_district_total = autonomous_data.get("to_district_total", 0)
              to_school_total = autonomous_data.get("to_school_total", 0)
              boarding_status = autonomous_data.get("boarding_status", "")
          else:
              # 数据缺失时使用默认值
              total_quota, sports_quota, art_quota = 0, 0, 0
              to_district_total, to_school_total = 0, 0
              boarding_status = ""
      except Exception:
          # 异常处理
          total_quota, sports_quota, art_quota = 0, 0, 0
          to_district_total, to_school_total = 0, 0
          boarding_status = ""
      
      # 查询其他数据（保持原有逻辑）
      district_seats = _get_district_seats(db, school_id, year)
      school_seats = _get_school_seats(db, school_id, year)
      parallel_scores = _get_parallel_scores(db, school_id, year)
      
      # 生成响应数据
      return {
          "id": school["code"],
          "name": school["name"],
          "code": school["code"],
          "district": school["district"],
          "type": school["type"],
          "fullType": school["full_type"],
          "note": school["note"],
          "introduction": _generate_introduction(school),
          "enrollment": {
              "totalQuota": total_quota,
              "sportsQuota": sports_quota,
              "artQuota": art_quota,
              "toDistrictTotal": to_district_total,
              "toSchoolTotal": to_school_total,
              "boardingStatus": boarding_status,
              "year": year
          },
          "scores": {
              "toDistrict": _calculate_score_range(district_seats),
              "toSchool": _calculate_score_range(school_seats),
              "unified": _calculate_avg_score(parallel_scores)
          }
      }
  ```

## 实现注意事项

### 1. 数据一致性
- 确保API返回的数据结构与前端组件期望的数据结构一致
- 处理好年份参数，确保获取对应年份的数据

### 2. 前端兼容性
- 确保新增的学生画像卡片在没有数据时能够正常显示
- 确保样式调整后在不同设备上的显示效果一致

### 3. 性能优化
- 后端API使用JOIN操作一次性查询所有相关数据
- 前端组件使用适当的缓存策略，避免重复请求

## 测试计划

### 1. API测试
- 测试不同学校代码的API响应
- 测试年份参数的影响
- 测试数据完整性和准确性

### 2. 前端测试
- 测试页面布局和卡片顺序
- 测试新增数据的显示效果
- 测试样式一致性
- 测试删除卡片后的页面结构

## 变更影响范围

### 1. 影响模块
- 学校详情模块（前端和后端）
- 相关API接口

### 2. 不影响模块
- 其他页面和功能模块
- 用户认证和权限系统
- 数据库结构（无需修改表结构）

## 风险评估

### 1. 低风险
- 数据获取逻辑变更：使用现有表结构，无需修改数据库
- 前端样式调整：仅调整布局和样式，不影响核心功能

### 2. 注意事项
- 确保自招表数据的完整性，避免数据缺失导致前端显示异常
- 确保前端组件能够处理数据为空的情况

## 交付物

### 1. 后端代码
- 修改后的`schools_service.py`文件
- 更新后的API接口文档

### 2. 前端代码
- 修改后的`SchoolDetailPage.tsx`文件
- 修改后的`SchoolEnrollmentSection.tsx`文件
- 修改后的`SchoolScoresSection.tsx`文件
- 新增的`SchoolProfileSection.tsx`文件

### 3. 文档
- 更新后的API契约文档
- 本需求变更文档